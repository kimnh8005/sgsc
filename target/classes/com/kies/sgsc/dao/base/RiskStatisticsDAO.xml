<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kies.sgsc.dao.base.RiskStatisticsDAO">

	<!-- 최종조회일시 획득. -->
	<select id="lastDateYmdHI" resultType="string">
		<![CDATA[
			SELECT MAX(ANYS_YMDHI) as anys_ymdhi FROM th_facty_risk_anay_rtme_load_min
		]]>
	</select>
	
	<!-- <select id="lastDateEqmtYmdHI" resultType="string">
		<![CDATA[
			SELECT MAX(ANYS_YMDHI) as anys_ymdhi FROM th_eqmt_risk_anay_rtme_load_min
		]]>
	</select> -->
	
	<select id="lastDateYmdH" resultType="string">
		<![CDATA[
			SELECT MAX(ANYS_YMDH) as anys_ymdh FROM th_eqmt_risk_anay_rtme_load_hourly
		]]>
	</select>
	
	
	<!--  전체시설 실시간시설위험도 -->
	<select id="allRtimeFactyRateRate" resultType="hashmap">
		<![CDATA[
			SELECT
				a.anys_ymdhi
				,a.risk_step_cd
				,t.cd_nm risk_step_nm
				,a.risk_num
				,a.risk_unit
			FROM th_facty_risk_anay_rtme_load_min a , tc_common_code t
			WHERE a.ANYS_YMDHI = #{anys_ymdhi}
			AND a.RISK_TYPE_ID = 'KIES101'  /* 통합시설위험도(실시간) */
			AND t.CD_GRP_ID='RISK_STEP_CD' 
			AND a.RISK_STEP_CD = t.cd_id
			ORDER BY a.risk_num desc
			LIMIT 1
		]]>
	</select>

	<!-- 위험도높은 시설 -->
	<select id="listRiskHigtFacty" resultType="hashmap">
		<![CDATA[
			SELECT
				a.anys_ymdhi
		    	, a.facty_id
		      	,(SELECT 
					f.FACTY_NM 
				 FROM tb_facility f 
				 WHERE  f.FACTY_ID = a.FACTY_ID ) facty_nm
				, risk_step_cd 
				,(SELECT 
					c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
				,risk_num
				,risk_unit
			FROM th_facty_risk_anay_rtme_load_min a
			WHERE ANYS_YMDHI = #{anys_ymdhi}
			AND RISK_TYPE_ID = 'KIES101' /* 통합시설위험도(실시간) */
			ORDER BY RISK_NUM DESC
			LIMIT 5
		]]>
	</select>
	
	
	<!-- 위험도높은 생산공정 -->
	<select id="listRiskHigtProcs" resultType="hashmap">
		<![CDATA[
			SELECT
				a.anys_ymdhi
				,b.facty_id as facty_id
				,b.facty_nm as facty_nm
		      	,b.procs_id as procs_id
		      	,b.procs_nm as procs_nm
				, risk_step_cd 
				,(SELECT 
						c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
				,risk_num
				,risk_unit
			FROM th_proces_risk_anay_rtme_load_min a , vw_process b
			WHERE anys_ymdhi = #{anys_ymdhi}
			and a.procs_id = b.procs_id
			AND RISK_TYPE_ID = 'KIES102' /* 통합공정위험도(실시간) */
			ORDER BY RISK_NUM DESC
			LIMIT 5
		]]>
	</select>
	
	<!-- 위험도높은 설비 -->
	<select id="listRiskHigtEqmt" resultType="hashmap">
		<![CDATA[
			SELECT
			    a.anys_ymdhi
			    ,a.anys_sys_cd
			    ,a.risk_step_cd
			    ,a.risk_type_id
				,b.facty_id as facty_id
				,b.facty_nm as facty_nm
				,b.procs_id as procs_id
		      	,b.procs_nm as procs_nm
		      	,b.eqmt_id as eqmt_id
		      	,b.eqmt_nm as eqmt_nm
				, risk_step_cd 
				,(select 
						c.cd_nm 
				  from tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  and c.cd_id = a.risk_step_cd) risk_step_nm
				,risk_num
				,risk_unit
				${causequery}
			FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
			WHERE anys_ymdhi = #{anys_ymdhi}
			and a.eqmt_id = b.eqmt_id 
			AND risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
			]]>
			<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
			<![CDATA[
			ORDER BY RISK_NUM DESC
			LIMIT ${topidx}
		]]>
	</select>
	
	
	<!-- 시나리오 용. 실시간 위험도 > 위험도 높은 설비<실시간 위험도 높은 설비>  -->
	<select id="listRiskHigtEqmtForSnro" resultType="hashmap">
	     <![CDATA[
			SELECT
				ma.facty_nm as facty_nm
				,ma.eqmt_id
				,ma.eqmt_nm as eqmt_nm
				,ma.risk_step_nm
				,ma.risk_num
				,ma.risk_unit
				,ma.procs_id
				,ma.procs_nm
				,ma.facty_id
				,ifnull(sc.NORL,0) norl
				,ifnull(sc.CARE,0) care
				,ifnull(sc.WARG,0) warg
				,ifnull(sc.EROR,0) eror
			FROM (
				SELECT
				    a.anys_ymdhi
				    ,a.anys_sys_cd
				    ,a.risk_step_cd
				    ,a.risk_type_id
					,b.facty_id as facty_id
					,b.facty_nm as facty_nm
					,b.procs_id as procs_id
			      	,b.procs_nm as procs_nm
			      	,b.eqmt_id as eqmt_id
			      	,b.eqmt_nm as eqmt_nm
					,(select 
							c.cd_nm 
					  from tc_common_code c 
					  WHERE CD_GRP_ID='RISK_STEP_CD' 
					  and c.cd_id = a.risk_step_cd) risk_step_nm
					,a.risk_num
					,a.risk_unit
				FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b 
				WHERE a.anys_ymdhi = #{anys_ymdhi}
				and a.eqmt_id = b.eqmt_id 
				and a.anys_sys_cd='KIES'
				AND a.risk_type_id = 'KIES103'
				]]>
				<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
				<![CDATA[
				ORDER BY RISK_NUM DESC
					LIMIT ${topidx}
				]]>
				<![CDATA[
				) ma LEFT OUTER join	
				(
					SELECT
						a.anys_ymdhi,
					   a.FACTORY_ID,   
					   SUM(case when b.CD_ADD_ITM='NORL' THEN 1 ELSE 0 END) NORL,
					   SUM(case when b.CD_ADD_ITM='CARE' THEN 1 ELSE 0 END) CARE,
					   SUM(case when b.CD_ADD_ITM='WARG' THEN 1 ELSE 0 END) WARG,
					   SUM(case when b.CD_ADD_ITM='EROR' THEN 1 ELSE 0 END) EROR
					FROM th_acdnt_scnrs_anay_load_min a, tc_common_code b
					WHERE a.anys_ymdhi = #{anys_ymdhi}
					AND a.anys_type_cd='AT1000'
					AND a.factory_hrrc_cd='FH3000'
					and a.anys_sys_cd='KIES'
					AND b.cd_grp_id='RISK_STEP_CD'
					AND a.risk_step_cd = b.CD_ID
					GROUP BY a.anys_ymdhi,
				    a.FACTORY_ID 
				) sc
			ON ma.anys_ymdhi = sc.anys_ymdhi
			AND ma.eqmt_id = sc.FACTORY_ID
		]]>
	</select>
	
	<!-- 위험도 높은 설비 의 이상원인 -->
	<select id="getRiskCauseEqmt" resultType="hashmap">
	<![CDATA[
		SELECT
			anys_ymdhi,
			eqmt_id,
			risk_type_id, 
			risk_step_cd ,
			(select 
					c.cd_nm 
			  from tc_common_code c 
			  WHERE CD_GRP_ID='RISK_STEP_CD' 
			  AND c.cd_id = a.risk_step_cd) risk_step_nm,
			risk_num
		FROM th_eqmt_risk_anay_rtme_load_min a
		WHERE anys_ymdhi = #{anys_ymdhi}
		AND anys_sys_cd = #{anys_sys_cd}
		AND risk_type_id = #{risk_type_id}
		AND eqmt_id = #{eqmt_id}
		ORDER BY risk_num DESC
		LIMIT 1
	]]>
	</select>
	
	
	<!-- 실시간위험도-설비분석데이터 -->
	<select id="listEqmtRiskCrig" resultType="hashmap">
	<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			    substr(anys_ymdh,1,8) ymd,
			    (SELECT 
					c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				 
				 case when b.use_yn='Y' then					    
						max(concat(lpad(risk_num,5,'0'), ':', 
						  (select 
									c.cd_nm 
							from tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.RISK_STEP_CD)))
					else
						Min(case when IFNULL(a.RISK_VAL,'') ='' then '정상' ELSE a.RISK_VAL end)
					end	 risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
		AND a.ANYS_SYS_CD='CRIG'
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
	]]>
	</select>
	
	
	<!-- 시나리오 실시간 위험도 > 설비분석데이터 <실시간 위험도 높은 설비의 24시간분석데이터> -->
	<select id="listEqmtRiskCrigForSnro" resultType="hashmap">
	<![CDATA[
		SELECT 
			ma.risk_type_nm,
			ma.ymd,
			ma.qtime,
			ma.risk_cls_nm,
			ma.risk_rate,
			ifnull(sc.NORL,0) norl,
			ifnull(sc.CARE,0) care,
			ifnull(sc.WARG,0) warg,
			ifnull(sc.EROR,0) eror
		FROM 
		(
			SELECT
				   a.risk_type_id,
				   b.risk_type_nm,
				  	case 
					  	when floor(substr(anys_ymdh,9)/3) = 0 then '00'
						when floor(substr(anys_ymdh,9)/3) = 1 then '03'
						when floor(substr(anys_ymdh,9)/3) = 2 then '06'
						when floor(substr(anys_ymdh,9)/3) = 3 then '09'
						when floor(substr(anys_ymdh,9)/3) = 4 then '12'
						when floor(substr(anys_ymdh,9)/3) = 5 then '15'
						when floor(substr(anys_ymdh,9)/3) = 6 then '18'
						when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
				    substr(anys_ymdh,1,8) ymd,
				    (SELECT 
						c.CD_NM 
					  FROM tc_common_code c 
					  WHERE CD_GRP_ID='RISK_CLS_CD' 
					  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
					 
					 case when b.use_yn='Y' then					    
							max(concat(lpad(risk_num,5,'0'), ':', 
							  (select 
										c.cd_nm 
								from tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.RISK_STEP_CD)))
						else
							Min(case when IFNULL(a.RISK_VAL,'') ='' then '정상' ELSE a.RISK_VAL end)
						end	 risk_rate
			FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
			WHERE anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
			AND a.risk_type_id='KIES103'
			AND a.risk_type_id = b.risk_type_id
			AND a.eqmt_id = #{eqmt_id}  
			GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
				case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
					when floor(substr(anys_ymdh,9)/3) = 1 then '03'
					when floor(substr(anys_ymdh,9)/3) = 2 then '06'
					when floor(substr(anys_ymdh,9)/3) = 3 then '09'
					when floor(substr(anys_ymdh,9)/3) = 4 then '12'
					when floor(substr(anys_ymdh,9)/3) = 5 then '15'
					when floor(substr(anys_ymdh,9)/3) = 6 then '18'
					when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		)ma
		LEFT OUTER join
		(	
			SELECT 
				case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			   substr(anys_ymdh,1,8) ymd,
			   SUM(case when b.CD_ADD_ITM='NORL' THEN 1 ELSE 0 END) NORL,
			   SUM(case when b.CD_ADD_ITM='CARE' THEN 1 ELSE 0 END) CARE,
			   SUM(case when b.CD_ADD_ITM='WARG' THEN 1 ELSE 0 END) WARG,
			   SUM(case when b.CD_ADD_ITM='EROR' THEN 1 ELSE 0 END) EROR
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			where a.anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
			AND a.factory_id=#{eqmt_id} 
			AND a.anys_type_cd='AT1000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.anys_sys_cd = 'KIES' 
			and b.cd_grp_id='RISK_STEP_CD'
			AND a.risk_step_cd = b.cd_id
			GROUP BY case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end,
			   substr(anys_ymdh,1,8) 
		) sc
		on ma.ymd  = sc.ymd
		AND ma.qtime = sc.qtime
	]]>
	</select>
	
	
	
	
	<!-- 실시간위험도-설비분석데이터 이상원인 모두 포함 -->
	<select id="listEqmtRiskCrigApp" resultType="hashmap">
	<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			   anys_ymdh,
			    substr(anys_ymdh,1,8) ymd,
			    substr(anys_ymdh,9,2) qtime,
			    (SELECT 
					c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				 case when b.use_yn='Y' then					    
						max(concat(lpad(risk_num,5,'0'), ':', 
						  (select 
									c.cd_nm 
							from tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.RISK_STEP_CD)))
					else
						Min(case when IFNULL(a.RISK_VAL,'') ='' then '정상' ELSE a.RISK_VAL end)
					end	 risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
		AND (a.ANYS_SYS_CD='CRIG' or b.risk_cls_cd = 'RC0002')
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY RISK_TYPE_ID, anys_ymdh
	]]>
	</select>
	
	
	<!-- 실시간위험도 - 예지보전 위험도 -->
	<select id="listEqmtRiskPARTDB" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
			substr(a.anys_ymdh,1,8) anys_ymd,
			(SELECT 
				EQMT_NM 
			FROM tb_equipment j 
			WHERE j.EQMT_ID =a.EQMT_ID) eqmt_nm,
			a.eqmt_id, 
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_CLS_CD' 
			  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			b.unit,			
			CASE WHEN b.RISK_CLS_CD = 'RC0001' then concat(lpad(a.RISK_NUM,5,'0'),':',(SELECT 
															c.CD_NM 
													  FROM tc_common_code c 
													  WHERE CD_GRP_ID='RISK_STEP_CD' 
													  AND c.cd_id = a.RISK_STEP_CD))
			WHEN USE_YN='Y' THEN a.RISK_NUM
			ELSE a.RISK_VAL END risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='PARTDB'
		AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
		AND EQMT_ID=#{eqmt_id}
	]]>
	</select>
	
	
	<!-- 시나리오 용  실시간 위험도 > 진단예지 위험도 -->
	<select id="listEqmtRiskPARTDBForSnro" resultType="hashmap">
	<![CDATA[
		 SELECT
	     	 ma.anys_ymdh,
	     	 ma.eqmt_nm,
	     	 ma.risk_value,
	     	 ma.risk_cls_nm,
	     	 ma.risk_type_nm,
	     	 ifnull(sc.NORL,0) norl,
				ifnull(sc.CARE,0) care,
				ifnull(sc.WARG,0) warg,
				ifnull(sc.EROR,0) eror
	     FROM
		  (
		     SELECT
				a.anys_ymdh,
				substr(a.anys_ymdh,1,8) anys_ymd,
				(SELECT 
					eqmt_nm 
				FROM tb_equipment j 
				WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
				a.eqmt_id, 
				a.risk_type_id , 
				b.risk_type_nm, 
				b.risk_cls_cd,
				(SELECT 
						c.CD_NM 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				b.unit,			
				CASE WHEN b.risk_cls_cd = 'RC0001' then concat(lpad(a.risk_num,5,'0'),':',(SELECT 
																c.cd_nm 
														  FROM tc_common_code c 
														  WHERE cd_grp_id='RISK_STEP_CD' 
														  AND c.cd_id = a.RISK_STEP_CD))
				WHEN USE_YN='Y' THEN a.risk_num
				ELSE a.risk_val END risk_value
			FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
			WHERE a.risk_type_id = b.risk_type_id
			AND a.ANYS_SYS_CD='PARTDB'
			AND a.risk_type_id='PART101'
			AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
			AND a.eqmt_id=#{eqmt_id}
			) ma
			LEFT OUTER JOIN 
			(
			SELECT 
			    a.factory_id,
				anys_ymdh,
			   SUM(case when b.cd_add_itm='NORL' THEN 1 ELSE 0 END) NORL,
			   SUM(case when b.cd_add_itm='CARE' THEN 1 ELSE 0 END) CARE,
			   SUM(case when b.cd_add_itm='WARG' THEN 1 ELSE 0 END) WARG,
			   SUM(case when b.cd_add_itm='EROR' THEN 1 ELSE 0 END) EROR   
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			WHERE b.CD_GRP_ID='RISK_STEP_CD'
			AND a.risk_step_cd = b.cd_id
			AND a.anys_type_cd='AT1000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.ANYS_SYS_CD = 'PARTDB'
			AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
			AND a.factory_id=#{eqmt_id}
			GROUP BY  anys_ymdh
		) sc
		ON ma.anys_ymdh = sc.anys_ymdh
		and ma.eqmt_id = sc.factory_id
	]]>
	</select>
	
	
	<!-- 실시간위험도 - 예지보전 위험도 앱용 -->
	<select id="listEqmtRiskPARTDBApp" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(a.anys_ymdh,1,8) anys_ymd,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='PARTDB' and b.RISK_CLS_CD in (${risk_cls_cds})
		AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
		AND EQMT_ID=#{eqmt_id}
		GROUP BY substr(a.anys_ymdh,1,8) , a.eqmt_id
		
	]]>
	</select>
	<!-- 
	SELECT
			substr(a.anys_ymdh,1,8) anys_ymd,
			a.anys_ymdh,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='PARTDB' and b.RISK_CLS_CD in (${risk_cls_cds})
		AND a.anys_ymdh =#{anys_ymdh}
		AND EQMT_ID=#{eqmt_id}
		GROUP BY a.anys_ymdh, a.eqmt_id -->
	
	
	<!-- 실시간위험도 - 영상데이터 분석 위험도 -->
	<select id="listEqmtRiskKSEC" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
			substr(a.anys_ymdh,1,8) anys_ymd,
			(SELECT EQMT_NM FROM tb_equipment j WHERE j.EQMT_ID =a.EQMT_ID) eqmt_nm,
			a.eqmt_id,
			b.risk_type_nm,
			b.risk_cls_cd,
			b.unit,	
			(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_CLS_CD' 
			  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			CASE WHEN b.RISK_CLS_CD = 'RC0001' then concat(lpad(a.RISK_NUM,5,'0'),':',(SELECT 
															c.CD_NM 
													  FROM tc_common_code c 
													  WHERE CD_GRP_ID='RISK_STEP_CD' 
													  AND c.cd_id = a.RISK_STEP_CD))
			WHEN USE_YN='Y' THEN a.RISK_NUM
			ELSE a.RISK_VAL END risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='KSEC'
		AND a.anys_ymdh =#{anys_ymdh}
		AND EQMT_ID=#{eqmt_id}
	]]>
	</select>
	
	<!-- 시나리오 용  실시간 위험도 > 영상데이터 분석 위험도 -->
	<select id="listEqmtRiskKSECForSnro" resultType="hashmap">
	<![CDATA[
		 SELECT
	     	 ma.anys_ymdh,
	     	 ma.eqmt_nm,
	     	 ma.risk_value,
	     	 ma.risk_cls_nm,
	     	 ma.risk_type_nm,
	     	 ifnull(sc.NORL,0) norl,
				ifnull(sc.CARE,0) care,
				ifnull(sc.WARG,0) warg,
				ifnull(sc.EROR,0) eror
	     FROM
		  (
		     SELECT
				a.anys_ymdh,
				substr(a.anys_ymdh,1,8) anys_ymd,
				(SELECT 
					eqmt_nm 
				FROM tb_equipment j 
				WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
				a.eqmt_id, 
				a.risk_type_id , 
				b.risk_type_nm, 
				b.risk_cls_cd,
				(SELECT 
						c.CD_NM 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				b.unit,			
				CASE WHEN b.risk_cls_cd = 'RC0001' then concat(lpad(a.risk_num,5,'0'),':',(SELECT 
																c.cd_nm 
														  FROM tc_common_code c 
														  WHERE cd_grp_id='RISK_STEP_CD' 
														  AND c.cd_id = a.RISK_STEP_CD))
				WHEN USE_YN='Y' THEN a.risk_num
				ELSE a.risk_val END risk_value
			FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
			WHERE a.risk_type_id = b.risk_type_id
			AND a.ANYS_SYS_CD='KSEC'
			AND a.risk_type_id='KSEC101'
			AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
			AND a.eqmt_id=#{eqmt_id}
			) ma
			LEFT OUTER JOIN 
			(
			SELECT 
			    a.factory_id,
				anys_ymdh,
			   SUM(case when b.cd_add_itm='NORL' THEN 1 ELSE 0 END) norl,
			   SUM(case when b.cd_add_itm='CARE' THEN 1 ELSE 0 END) care,
			   SUM(case when b.cd_add_itm='WARG' THEN 1 ELSE 0 END) warg,
			   SUM(case when b.cd_add_itm='EROR' THEN 1 ELSE 0 END) eror   
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			WHERE b.CD_GRP_ID='RISK_STEP_CD'
			AND a.risk_step_cd = b.cd_id
			AND a.anys_type_cd='AT1000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.ANYS_SYS_CD = 'KSEC'
			AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
			AND a.factory_id=#{eqmt_id}
			GROUP BY  anys_ymdh
		) sc
		ON ma.anys_ymdh = sc.anys_ymdh
		and ma.eqmt_id = sc.factory_id
	]]>
	</select>
	
	<!-- 사고시나리오 실시간 시분 팝업- 위험율 (통합위험율: KIES01, KSEC01:위험율,  PARTDB:고장확율, CRIG:발생확율
		anys_type_cd- AT1000:실시간  AT2000:예측 
		factory_hrrc_cd : 'FH1000':계통(시설), FH1000:FH3000 FH2000:시설(공정)
		factory_id : 각 아이디
	-->
	<select id="lisScnrsMinDesc" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh as anys_ymdh,
		    a.factory_id as factory_id ,
			c.scen_nm as scen_nm ,
			c.scen_cause as scen_cause,
			c.scen_result as scen_result,
			c.etc as etc,	
			MAX(  concat(lpad(a.RISK_NUM,5,'0'),':',(SELECT 
					c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  AND c.cd_id = a.RISK_STEP_CD)) ) risk_rate
		FROM th_acdnt_scnrs_anay_load_hourly a, tc_common_code b, tc_acdent_scnrs c
		WHERE a.anys_ymdh = #{anys_ymdh}
		AND b.CD_GRP_ID='RISK_STEP_CD'
		AND a.RISK_STEP_CD = b.CD_ID
		AND a.anys_type_cd= #{anys_type_cd}    
		AND a.factory_hrrc_cd= ifnull(#{factory_hrrc_cd}, a.factory_hrrc_cd)
		AND a.factory_id=#{factory_id}
		AND a.SCEN_ID = c.SCEN_ID
		GROUP BY a.anys_ymdh,
		   a.factory_id,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc 
	]]>
	</select>
	
	<!--시나리오 팝업 시간 -->
	<select id="lisScnrsHourDesc" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
		    a.factory_id,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc,	
			MAX(  concat(lpad(a.RISK_NUM,5,'0'),':',(SELECT 
					c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  AND c.cd_id = a.RISK_STEP_CD)) ) risk_rate
		FROM th_acdnt_scnrs_anay_load_hourly a, tc_common_code b, tc_acdent_scnrs c
		WHERE a.anys_ymdh = #{anys_ymdh}
		AND b.cd_grp_id='RISK_STEP_CD'
		AND a.risk_step_cd = b.CD_ID
		AND a.anys_type_cd= #{anys_type_cd}  
		AND a.anys_sys_cd = #{anys_sys_cd}   
		AND a.factory_id=#{factory_id}
		AND a.scen_id = c.SCEN_ID
		GROUP BY a.anys_ymdh,
		   a.factory_id,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc 
	]]>
	</select>
	
	<!-- 실시간위험도 - 영상데이터 분석 위험도 앱용 -->
	<select id="listEqmtRiskKSECApp" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(a.anys_ymdh,1,8) anys_ymd,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='KSEC'  and b.RISK_CLS_CD in (${risk_cls_cds}) 
		AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
		AND EQMT_ID=#{eqmt_id}
		GROUP BY substr(a.anys_ymdh,1,8), a.eqmt_id
	]]>
	</select>
	
	<!-- 
	SELECT
			a.anys_ymdh,
			substr(a.anys_ymdh,1,8) anys_ymd,			
			concat(a.anys_ymdh,'0101') anys_ymdhis,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='KSEC'  and b.RISK_CLS_CD in (${risk_cls_cds}) 
		AND a.anys_ymdh =#{anys_ymdh}
		AND EQMT_ID=#{eqmt_id}
		GROUP BY a.anys_ymdh, a.eqmt_id -->
	
	
	<!-- 위험도 예측 - 예측위험도 높은 설비 -->
	<select id="listPractEqmtRiskTop5" resultType="hashmap">
	<![CDATA[
		SELECT 
			b.facty_id
			,b.facty_nm
			,b.procs_id
			,b.procs_nm
			,b.eqmt_id
			,b.eqmt_nm
			,a.risk_step_cd
			, (select 
							c.CD_NM 
					FROM tc_common_code c 
					WHERE CD_GRP_ID='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
			,a.risk_num
			,a.risk_unit
		FROM th_eqmt_risk_anay_pract_load_hourly a, vw_equipment b
		WHERE ANYS_YMDH BETWEEN  #{anys_ymdh} and #{end_anys_ymdh}
		AND a.EQMT_ID= b.EQMT_ID
		ORDER BY RISK_NUM DESC
		LIMIT ${topidx}
	]]>
	</select>
	
		
	<!--위험도 예측>설비예측> 리스트> 24시간   -->
	<select id="pagePractEqmtRiskHourMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
		      			   d.eqmt_id as eqmt_id,
		      			   d.eqmt_nm as eqmt_nm,
						   a.anys_ymdh,
						   a.risk_num,
							  (select 
										c.cd_nm 
								from tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
					FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
					WHERE a.anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
					and a.risk_type_id='KIES203'
					and a.eqmt_id = d.eqmt_id
					and a.risk_type_id = b.risk_type_id
				]]>
					<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
					<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
					<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
				<![CDATA[	
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!--위험도 예측>설비예측> 24시간 총건수  -->
	<select id="countPractEqmtRiskHourMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
			WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
			and a.risk_type_id='KIES203'
			AND a.EQMT_ID = d.eqmt_id
			and a.risk_type_id = b.risk_type_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
	</select>
	
	
	<!--위험도 예측>설비예측> 리스트> 일간시간   -->
	<select id="pagePractEqmtRiskDayMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
		      			   d.eqmt_id as eqmt_id,
		      			   d.eqmt_nm as eqmt_nm,
						   a.anys_ymd,
						   a.risk_num,
							  (select 
										c.cd_nm 
								from tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
					FROM th_eqmt_risk_anay_pract_load_daily a , vw_equipment d, tc_risk_type b
					WHERE a.anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
					and a.risk_type_id='KIES203'
					and a.eqmt_id = d.eqmt_id
					and a.risk_type_id = b.risk_type_id
				]]>
					<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
					<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
					<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
				<![CDATA[	
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!--위험도 예측>설비예측> 일간 총건수  -->
	<select id="countPractEqmtRiskDayMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_eqmt_risk_anay_pract_load_daily a , vw_equipment d, tc_risk_type b
			WHERE a.anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
			and a.risk_type_id='KIES203'
			and a.eqmt_id = d.eqmt_id
			and a.risk_type_id = b.risk_type_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
	</select>
	
	
	
	
	
	<!--위험도 예측>설비예측> 24시간 예측  -->
	<select id="listPractEqmtRiskHour24" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			    substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
		AND a.RISK_TYPE_ID='KIES203'
		AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		]]>
	</select>
	
	<!--시나리오 위험도 예측>설비예측> 24시간 예측  -->
	<select id="listPractEqmtRiskHour24ForSnro" resultType="hashmap">
	<![CDATA[
		SELECT 
			ma.risk_type_nm,
			ma.ymd,
			ma.qtime,
			ma.risk_cls_nm,
			ma.risk_rate,
			ifnull(sc.NORL,0) norl,
			ifnull(sc.CARE,0) care,
			ifnull(sc.WARG,0) warg,
			ifnull(sc.EROR,0) eror
		FROM 
		(
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			    substr(anys_ymdh,1,8) ymd,
			    (SELECT 
						c.CD_NM 
					  FROM tc_common_code c 
					  WHERE CD_GRP_ID='RISK_CLS_CD' 
					  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
		AND a.RISK_TYPE_ID='KIES203'
		AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		)ma
		LEFT OUTER join
		(
			SELECT 
				case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			   substr(anys_ymdh,1,8) ymd,
			   SUM(case when b.CD_ADD_ITM='NORL' THEN 1 ELSE 0 END) NORL,
			   SUM(case when b.CD_ADD_ITM='CARE' THEN 1 ELSE 0 END) CARE,
			   SUM(case when b.CD_ADD_ITM='WARG' THEN 1 ELSE 0 END) WARG,
			   SUM(case when b.CD_ADD_ITM='EROR' THEN 1 ELSE 0 END) EROR
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			where a.anys_ymdh between #{anys_ymdh} and #{end_anys_ymdh}
			AND a.FACTORY_ID=#{eqmt_id} 
			AND a.anys_type_cd='AT2000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.ANYS_SYS_CD = 'KIES' 
			and b.CD_GRP_ID='RISK_STEP_CD'
			AND a.RISK_STEP_CD = b.CD_ID
			GROUP BY case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end,
			   substr(anys_ymdh,1,8) 
		) sc
		on ma.ymd  = sc.ymd
		AND ma.qtime = sc.qtime
	]]>	
	</select>
	
	
	
	
	
	<!-- 7일 예측 -->
	<select id="listPractEqmtRiskDay7" resultType="hashmap">
		<![CDATA[
			SELECT
				   a.risk_type_id,
				   b.risk_type_nm,			  	
				    substr(anys_ymdh,1,8) ymd,
					max(concat(lpad(risk_num,5,'0'), ':', 
					  (select 
								c.cd_nm 
						from tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.RISK_STEP_CD))) risk_rate
			FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
			WHERE anys_ymdh BETWEEN  #{anys_ymdh} and #{end_anys_ymdh}
			AND a.RISK_TYPE_ID='KIES203'
			AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
			AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
			GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) 
		]]>
	</select>
	
	<!-- 4주 예측 -->
	<select id="getPractEqmtRiskDay7forWeek" resultType="hashmap">
		<![CDATA[
			SELECT
			   CONCAT(SUBSTR(#{anys_ymdh},1,8),'~', SUBSTR(#{end_anys_ymdh},1,8)) risk_dt,
			   a.risk_type_id,
			   b.risk_type_nm,  	
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
		AND a.RISK_TYPE_ID='KIES203'
		AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID
		]]>
	</select>
	
 	
 	
 	<!-- 위험도이력 생산공정 조회-->
	<select id="listRisktProcsHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdhi
			,b.facty_id as facty_id
			,b.facty_nm as facty_nm
	      	,b.procs_id as procs_id
	      	,b.procs_nm as procs_nm
			, risk_step_cd 
			,(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_STEP_CD' 
			  AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
			,risk_num
			,risk_unit
		FROM th_proces_risk_anay_rtme_load_min a , vw_process b
		WHERE anys_ymdhi between #{anys_ymdhi} and #{end_anys_ymdhi}
		AND a.procs_id = b.procs_id
		AND RISK_TYPE_ID = 'KIES102' 
		]]>
		
		<if test='risk_step_cd.size !=0'>
			AND risk_step_cd IN (SELECT 
						g.CD_ID 
				  FROM tc_common_code g 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  AND CD_ADD_ITM IN 			
			   <foreach collection="risk_step_cd" item="value"  open="(" close=")" separator=",">
		            #{value}
		        </foreach>
		     )
		 </if>
		 <![CDATA[
		ORDER BY RISK_NUM DESC
		]]>
	</select>
	
	
	<!-- 위험도이력 생산공정 조회 페이징 -->
	<select id="pageRisktProcsHistory" resultType="hashmap">
	<![CDATA[
		SELECT * FROM ( 
			SELECT 
				@rownum:=@rownum+1 RO, 
				A.* 
			FROM 
			(
				SELECT
					a.anys_ymdhi
					,b.facty_id as facty_id
					,b.facty_nm as facty_nm
			      	,b.procs_id as procs_id
			      	,b.procs_nm as procs_nm
					, risk_step_cd 
					,(SELECT 
							c.CD_NM 
					  FROM tc_common_code c 
					  WHERE CD_GRP_ID='RISK_STEP_CD' 
					  AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
					,risk_num
					,risk_unit
				FROM th_proces_risk_anay_rtme_load_min a , vw_process b
				WHERE anys_ymdhi between #{anys_ymdhi} and #{end_anys_ymdhi}
				AND a.procs_id = b.procs_id
				AND RISK_TYPE_ID = 'KIES102' 
				]]>
				
				<if test='risk_step_cd.size !=0'>
					AND risk_step_cd IN (SELECT 
								g.CD_ID 
						  FROM tc_common_code g 
						  WHERE CD_GRP_ID='RISK_STEP_CD' 
						  AND CD_ADD_ITM IN 			
					   <foreach collection="risk_step_cd" item="value"  open="(" close=")" separator=",">
				            #{value}
				        </foreach>
				     )
				 </if>
				 <![CDATA[
				ORDER BY RISK_NUM DESC
				) A,
				(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!-- 위험도이력 생산공정 조회 건수 -->
	<select id="countRisktProcsHistory" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_proces_risk_anay_rtme_load_min a , vw_process b
			WHERE anys_ymdhi between #{anys_ymdhi} and #{end_anys_ymdhi}
			AND a.procs_id = b.procs_id
			AND RISK_TYPE_ID = 'KIES102'
		]]>
		<if test='risk_step_cd.size !=0'>
			AND risk_step_cd IN (SELECT 
						g.CD_ID 
				  FROM tc_common_code g 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  AND CD_ADD_ITM IN 			
			   <foreach collection="risk_step_cd" item="value"  open="(" close=")" separator=",">
		            #{value}
		        </foreach>
		     )
		 </if>
	</select>
	
	
	
	<!-- 위험도이력 생산공정 상세 3시간-->
	<select id="listRiskProcs3HourHistory" resultType="hashmap">
		<![CDATA[		
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			    substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_proces_risk_anay_rtme_load_hourly a , vw_process d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		and a.RISK_TYPE_ID='KIES102'
		AND a.procs_id = d.procs_id	
		AND a.procs_id = #{procs_id}
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		]]>
	</select>
	
	<!-- 위험도이력 생산공정 상세 일별 -->
	<select id="listRiskProcsDayHistory" resultType="hashmap">
		<![CDATA[		
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,			  
			   substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_proces_risk_anay_rtme_load_hourly a , vw_process d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		and a.RISK_TYPE_ID='KIES102'
		AND a.procs_id = d.procs_id	
		AND a.procs_id = #{procs_id}
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) 
		]]>
	</select>
	
	
	<!-- 위험도이력 설비별 상세 3시간-->
	<select id="listRiskEqmt3HourHistory" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			    substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES103'
		AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		]]>
	</select>
	
	<!-- 위험도이력 설비별 상세 일별
	<select id="listRiskEqmtDayHistory" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			    substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES103'
		AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8)
		]]>
	</select>-->
	
	<!-- 위험도이력 설비별 상세 일별-->
	<select id="listRiskEqmtDayHistory" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			   anys_ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_daily a , vw_equipment d, tc_risk_type b
		WHERE a.anys_ymd BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES203'
		AND a.EQMT_ID = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.RISK_TYPE_ID = b.RISK_TYPE_ID
		GROUP BY RISK_TYPE_ID,a.anys_ymd
		order by anys_ymd desc
		]]>
	</select>
	
	
	
	<!-- 위험도이력 - 센서데이터 분석 위험도 -->
	<select id="listRiskCRIG3HourHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(anys_ymdh,1,8) ymd,
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_CLS_CD' 
			  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			b.unit,			
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='CRIG'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY  substr(anys_ymdh,1,8) ,RISK_TYPE_ID, b.risk_cls_cd ,
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		ORDER BY substr(anys_ymdh,1,8) ,RISK_TYPE_ID
	]]>
	</select>
	
	
	<!-- 위험도이력 - 센서데이터 분석 위험도 시나리오포함 -->
	<select id="listRiskCRIG3HourHistoryForSnro" resultType="hashmap">
	<![CDATA[
		SELECT 
			ma.risk_type_nm,
			ma.ymd,
			ma.qtime,
			ma.risk_cls_nm,
			ma.risk_rate,
			ifnull(sc.NORL,0) norl,
			ifnull(sc.CARE,0) care,
			ifnull(sc.WARG,0) warg,
			ifnull(sc.EROR,0) eror
		FROM 
		(
			SELECT
				substr(anys_ymdh,1,8) ymd,
				a.risk_type_id , 
				b.risk_type_nm, 
				b.risk_cls_cd,
				(SELECT 
						c.CD_NM 
				  FROM tc_common_code c 
				  WHERE CD_GRP_ID='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				b.unit,			
				case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
					when floor(substr(anys_ymdh,9)/3) = 1 then '03'
					when floor(substr(anys_ymdh,9)/3) = 2 then '06'
					when floor(substr(anys_ymdh,9)/3) = 3 then '09'
					when floor(substr(anys_ymdh,9)/3) = 4 then '12'
					when floor(substr(anys_ymdh,9)/3) = 5 then '15'
					when floor(substr(anys_ymdh,9)/3) = 6 then '18'
					when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
					max(concat(lpad(risk_num,5,'0'), ':', 
					  (select 
								c.cd_nm 
						from tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.RISK_STEP_CD))) risk_rate
			FROM th_eqmt_risk_anay_pract_load_hourly a , tc_risk_type b
			WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
			AND a.ANYS_SYS_CD='KIES'
			and a.RISK_TYPE_ID ='KIES203'
			AND SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
			AND a.eqmt_id = #{eqmt_id}
			GROUP BY  substr(anys_ymdh,1,8) ,RISK_TYPE_ID, b.risk_cls_cd ,
				case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
					when floor(substr(anys_ymdh,9)/3) = 1 then '03'
					when floor(substr(anys_ymdh,9)/3) = 2 then '06'
					when floor(substr(anys_ymdh,9)/3) = 3 then '09'
					when floor(substr(anys_ymdh,9)/3) = 4 then '12'
					when floor(substr(anys_ymdh,9)/3) = 5 then '15'
					when floor(substr(anys_ymdh,9)/3) = 6 then '18'
					when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
			ORDER BY substr(anys_ymdh,1,8) ,RISK_TYPE_ID
		)ma
		LEFT OUTER join
		(	
			SELECT 
				case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			   substr(anys_ymdh,1,8) ymd,
			   SUM(case when b.CD_ADD_ITM='NORL' THEN 1 ELSE 0 END) NORL,
			   SUM(case when b.CD_ADD_ITM='CARE' THEN 1 ELSE 0 END) CARE,
			   SUM(case when b.CD_ADD_ITM='WARG' THEN 1 ELSE 0 END) WARG,
			   SUM(case when b.CD_ADD_ITM='EROR' THEN 1 ELSE 0 END) EROR
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			where SUBSTR(a.anys_ymdh,1,8) between #{strt_anys_ymd} and #{end_anys_ymd}
			AND a.factory_id=#{eqmt_id} 
			AND a.anys_type_cd='AT2000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.anys_sys_cd = 'KIES' 
			and b.cd_grp_id='RISK_STEP_CD'
			AND a.risk_step_cd = b.cd_id
			GROUP BY case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end,
			   substr(anys_ymdh,1,8) 
		) sc
		on ma.ymd  = sc.ymd
		AND ma.qtime = sc.qtime
	]]>
	</select>
	
	
	
	
	
	<!-- 위험도이력 - 센서데이터 분석 위험도 앱용 소트-->
	<select id="listRiskCRIG3HourHistoryApp" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(anys_ymdh,1,8) ymd,
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_CLS_CD' 
			  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			b.unit,			
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='CRIG'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY  substr(anys_ymdh,1,8) ,
		case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		,RISK_TYPE_ID, b.risk_cls_cd 
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 예지보전 위험도 -->
	<select id="listRiskPARTDB3HourHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(a.anys_ymdh,1,8) ymd,
			a.eqmt_id, 
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_CLS_CD' 
			  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			b.unit,			
			MAX(CASE WHEN b.RISK_CLS_CD = 'RC0001' then CONCAT(lpad(a.RISK_STEP_LVL,2,0) ,':',(SELECT 
															c.CD_NM 
													  FROM tc_common_code c 
													  WHERE CD_GRP_ID='RISK_STEP_CD' 
													  AND c.cd_id = a.RISK_STEP_CD))
			WHEN USE_YN='Y' THEN a.RISK_NUM
			ELSE a.RISK_VAL END) risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='PARTDB'
		AND substr(anys_ymdh,1,8) between #{anys_ymd} and #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY substr(a.anys_ymdh,1,8) ,a.risk_type_id, b.risk_cls_cd
	]]>
	</select>
	
	<!-- 위험도 이력 - 예지보전 위험도 시나리오 -->
	<select id="listRiskPARTDB3HourHistoryForsnro" resultType="hashmap">
	<![CDATA[
		SELECT
	     	 ma.anys_ymdh,
	     	 ma.eqmt_nm,
	     	 ma.risk_value,
	     	 ma.risk_cls_nm,
	     	 ma.risk_type_nm,
	     	 ifnull(sc.NORL,0) norl,
			 ifnull(sc.CARE,0) care,
			 ifnull(sc.WARG,0) warg,
			 ifnull(sc.EROR,0) eror
	     FROM
		  (
		     SELECT
				a.anys_ymdh,
				substr(a.anys_ymdh,1,8) anys_ymd,
				(SELECT 
					eqmt_nm 
				FROM tb_equipment j 
				WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
				a.eqmt_id, 
				a.risk_type_id , 
				b.risk_type_nm, 
				b.risk_cls_cd,
				(SELECT 
						c.CD_NM 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				b.unit,			
				CASE WHEN b.risk_cls_cd = 'RC0001' then concat(lpad(a.risk_num,5,'0'),':',(SELECT 
																c.cd_nm 
														  FROM tc_common_code c 
														  WHERE cd_grp_id='RISK_STEP_CD' 
														  AND c.cd_id = a.RISK_STEP_CD))
				WHEN USE_YN='Y' THEN a.risk_num
				ELSE a.risk_val END risk_value
			FROM th_eqmt_risk_anay_pract_load_hourly a , tc_risk_type b
			WHERE a.risk_type_id = b.risk_type_id
			AND a.ANYS_SYS_CD='PARTDB'
			AND a.risk_type_id='PART101'
			AND a.anys_ymdh between #{anys_ymd} and #{end_anys_ymd}
			AND a.eqmt_id=#{eqmt_id}
			) ma
			LEFT OUTER JOIN 
			(
			SELECT 
			    a.factory_id,
				anys_ymdh,
			   SUM(case when b.cd_add_itm='NORL' THEN 1 ELSE 0 END) NORL,
			   SUM(case when b.cd_add_itm='CARE' THEN 1 ELSE 0 END) CARE,
			   SUM(case when b.cd_add_itm='WARG' THEN 1 ELSE 0 END) WARG,
			   SUM(case when b.cd_add_itm='EROR' THEN 1 ELSE 0 END) EROR   
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			WHERE b.CD_GRP_ID='RISK_STEP_CD'
			AND a.risk_step_cd = b.cd_id
			AND a.anys_type_cd='AT2000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.ANYS_SYS_CD = 'PARTDB'
			AND a.anys_ymdh between #{anys_ymd} and #{end_anys_ymd}
			AND a.factory_id=#{eqmt_id}
			GROUP BY  anys_ymdh
		) sc
		ON ma.anys_ymdh = sc.anys_ymdh
		and ma.eqmt_id = sc.factory_id
	]]>
	</select> 
	
	
	<!-- 위험도 이력 - 예지보전 위험도 앱용-->
	<select id="listRiskPARTDB3HourHistoryApp" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(a.anys_ymdh,1,8) ymd,
			a.eqmt_id 
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='PARTDB'
		AND substr(anys_ymdh,1,8) between #{anys_ymd} and #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY substr(a.anys_ymdh,1,8) ,a.eqmt_id
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 영상데이터 분석 위험도 -->
	<select id="listRiskKSEC3HourHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(anys_ymdh,1,8) ymd,
			(SELECT EQMT_NM FROM tb_equipment j WHERE j.EQMT_ID =a.EQMT_ID) eqmt_nm,
			a.eqmt_id,
			a.risk_type_id,
			b.risk_type_nm,
			b.risk_cls_cd,
			b.unit,	
			(SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_CLS_CD' 
			  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			MAX(concat(lpad(risk_num,5,'0'), ':', (SELECT 
					c.CD_NM 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_STEP_CD' 
			  AND c.cd_id = a.RISK_STEP_CD) ) )risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='KSEC'
		AND substr(anys_ymdh,1,8) between #{anys_ymd} and #{end_anys_ymd}
		AND EQMT_ID=#{eqmt_id}
		GROUP BY substr(anys_ymdh,1,8),a.risk_type_id,b.risk_cls_cd
	]]>
	</select>
	
	
	
	
	<!-- 위험도 이력 - 영상데이터 분석 위험도 시나리오 -->
	<select id="listRiskKSEC3HourHistoryForsnro" resultType="hashmap">
	<![CDATA[
		SELECT
	     	 ma.anys_ymdh,
	     	 ma.eqmt_nm,
	     	 ma.risk_value,
	     	 ma.risk_cls_nm,
	     	 ma.risk_type_nm,
	     	 ifnull(sc.NORL,0) norl,
				ifnull(sc.CARE,0) care,
				ifnull(sc.WARG,0) warg,
				ifnull(sc.EROR,0) eror
	     FROM
		  (
		     SELECT
				a.anys_ymdh,
				substr(a.anys_ymdh,1,8) anys_ymd,
				(SELECT 
					eqmt_nm 
				FROM tb_equipment j 
				WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
				a.eqmt_id, 
				a.risk_type_id , 
				b.risk_type_nm, 
				b.risk_cls_cd,
				(SELECT 
						c.CD_NM 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
				b.unit,			
				CASE WHEN b.risk_cls_cd = 'RC0001' then concat(lpad(a.risk_num,5,'0'),':',(SELECT 
																c.cd_nm 
														  FROM tc_common_code c 
														  WHERE cd_grp_id='RISK_STEP_CD' 
														  AND c.cd_id = a.RISK_STEP_CD))
				WHEN USE_YN='Y' THEN a.risk_num
				ELSE a.risk_val END risk_value
			FROM th_eqmt_risk_anay_pract_load_hourly a , tc_risk_type b
			WHERE a.risk_type_id = b.risk_type_id
			AND a.ANYS_SYS_CD='KSEC'
			AND a.risk_type_id='KSEC101'
			AND a.anys_ymdh between  #{anys_ymd} and #{end_anys_ymd}
			AND a.eqmt_id=#{eqmt_id}
			) ma
			LEFT OUTER JOIN 
			(
			SELECT 
			    a.factory_id,
				anys_ymdh,
			   SUM(case when b.cd_add_itm='NORL' THEN 1 ELSE 0 END) NORL,
			   SUM(case when b.cd_add_itm='CARE' THEN 1 ELSE 0 END) CARE,
			   SUM(case when b.cd_add_itm='WARG' THEN 1 ELSE 0 END) WARG,
			   SUM(case when b.cd_add_itm='EROR' THEN 1 ELSE 0 END) EROR   
			FROM th_acdnt_scnrs_anay_load_hourly a , tc_common_code b
			WHERE b.CD_GRP_ID='RISK_STEP_CD'
			AND a.risk_step_cd = b.cd_id
			AND a.anys_type_cd='AT2000'
			AND a.factory_hrrc_cd='FH3000'
			AND a.ANYS_SYS_CD = 'KSEC'
			AND a.anys_ymdh between  #{anys_ymd} and #{end_anys_ymd}
			AND a.factory_id=#{eqmt_id}
			GROUP BY  anys_ymdh
		) sc
		ON ma.anys_ymdh = sc.anys_ymdh
		and ma.eqmt_id = sc.factory_id
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 영상데이터 분석 위험도 앱용 -->
	<select id="listRiskKSEC3HourHistoryApp" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(anys_ymdh,1,8) ymd,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.RISK_TYPE_ID = b.RISK_TYPE_ID
		AND a.ANYS_SYS_CD='KSEC'
		AND substr(anys_ymdh,1,8) between #{anys_ymd} and #{end_anys_ymd}
		AND EQMT_ID=#{eqmt_id}
		GROUP BY substr(anys_ymdh,1,8),a.eqmt_id
	]]>
	</select>
	
	
	<!-- 가스위험성 제안 설비 -->
	<select id="listProposeGasRisk" resultType="hashmap">
		<![CDATA[
			SELECT
			    a.anys_ymdhi
			    ,a.anys_sys_cd
			    ,a.risk_step_cd
			    ,a.risk_type_id
				,b.facty_id as facty_id
				,b.facty_nm as facty_nm
				,b.procs_id as procs_id
		      	,b.procs_nm as procs_nm
		      	,b.eqmt_id as eqmt_id
		      	,b.eqmt_nm as eqmt_nm
				, risk_step_cd 
				,(select 
						c.cd_nm 
				  from tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  and c.cd_id = a.risk_step_cd) risk_step_nm
				,risk_num
				,risk_unit
			FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
			WHERE substr(a.anys_ymdhi,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
			and a.eqmt_id = b.eqmt_id 
			AND risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
			]]>
			<if test='eqmt_id != null and eqmt_id != ""'>AND a.eqmt_id = #{eqmt_id}</if>
			<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
			<if test='facty_id != null and facty_id != ""'>AND b.facty_id = #{facty_id}</if>
		<![CDATA[	
			ORDER BY RISK_NUM DESC
		]]>
	</select>
	
	
	<select id="pageProposeGasRisk" resultType="hashmap">
		<![CDATA[
			SELECT * FROM ( 
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
					    a.anys_ymdhi
					    ,a.anys_sys_cd
					    ,a.risk_step_cd
					    ,a.risk_type_id
						,b.facty_id as facty_id
						,b.facty_nm as facty_nm
						,b.procs_id as procs_id
				      	,b.procs_nm as procs_nm
				      	,b.eqmt_id as eqmt_id
				      	,b.eqmt_nm as eqmt_nm
						,(select 
								c.cd_nm 
						  from tc_common_code c 
						  WHERE CD_GRP_ID='RISK_STEP_CD' 
						  and c.cd_id = a.risk_step_cd) risk_step_nm
						,risk_num
						,risk_unit
					FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
					WHERE a.anys_ymdhi BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
					and a.eqmt_id = b.eqmt_id 
					AND risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
		]]>
					<if test='eqmt_id != null and eqmt_id != ""'>AND a.eqmt_id = #{eqmt_id}</if>
					<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
					<if test='facty_id != null and facty_id != ""'>AND b.facty_id = #{facty_id}</if>
		<![CDATA[
					/*ORDER BY update_date DESC*/
				) A,
				(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>

	<select id="countProposeGasRisk" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
			WHERE substr(a.anys_ymdhi,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
			and a.eqmt_id = b.eqmt_id 
			AND risk_type_id = 'KIES103'
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND a.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND b.facty_id = #{facty_id}</if>
	</select>
	
	
	
	
	<!-- 위험도예측>시설 전체 -->
	<select id="getPractFactyRiskAll" resultType="hashmap">
	<![CDATA[
		SELECT
			max(concat(lpad(risk_num,5,'0'), ':', 
			  (select 
						c.cd_nm 
				from tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_facty_risk_anay_pract_load_daily a
		WHERE ANYS_YMD BETWEEN  #{anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES201'
	]]>
	</select>
	
	<!-- 위험도예측>시설24시간 예측  -->
	<select id="listPractFactyRiskHour24" resultType="hashmap">
		<![CDATA[
		SELECT
		    a.risk_type_id,			
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
	 			when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
		    substr(a.anys_ymdh,1,8) ymd,	   
			max(concat(lpad(a.risk_num,5,'0'), ':', 
			  (select 
						c.cd_nm 
				from tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM  th_facty_risk_anay_pract_load_hourly a
		WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
		AND a.RISK_TYPE_ID='KIES201'
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
	 			when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		]]>
	</select>
	
	<!-- 위험도예측>시설7일 예측 -->
	<select id="listPractFactyRiskDay7" resultType="hashmap">
		<![CDATA[
		SELECT
		   a.risk_type_id,
		   a.anys_ymd,
			max(concat(lpad(risk_num,5,'0'), ':', 
			  (select 
						c.cd_nm 
				from tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_facty_risk_anay_pract_load_daily a
		WHERE anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES201'
		GROUP BY a.risk_type_id,   a.anys_ymd
		]]>
	</select>
	
	<!-- 위험도예측>시설4주 예측 -->
	<select id="getPractFactyRiskDay7forWeek" resultType="hashmap">
		<![CDATA[
		SELECT
			   CONCAT(#{anys_ymd},'~', #{end_anys_ymd}) risk_dt,
			   a.risk_type_id,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_facty_risk_anay_pract_load_daily a 
		WHERE anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES201'
		]]>
	</select>
	
	
	<!-- 위험도예측> 생산공정 > 리스트 > 24시간  페이징-->
	<select id="pagePractProcsRiskHourMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
						   a.anys_ymdh,
						   a.risk_num,
							  (select 
										c.cd_nm 
								from tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
					FROM th_proces_risk_anay_pract_load_hourly a , vw_process d, tc_risk_type b
					WHERE a.anys_ymdh between #{anys_ymdh} and #{end_anys_ymdh}
					AND a.RISK_TYPE_ID='KIES202'
					AND a.procs_id = d.procs_id
					and a.risk_type_id = b.risk_type_id
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 24시간 리스트 총건수  -->
	<select id="countPractProcsRiskHourMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_proces_risk_anay_pract_load_hourly a , vw_process d, tc_risk_type b
			WHERE a.anys_ymdh between #{anys_ymdh} and #{end_anys_ymdh}
			AND a.RISK_TYPE_ID='KIES202'
			AND a.procs_id = d.procs_id
			and a.risk_type_id = b.risk_type_id
		]]>
	</select>
	
	
	<!-- 위험도예측> 생산공정 > 리스트 > 일별  페이징-->
	<select id="pagePractProcsRiskDayMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
						   a.anys_ymd,
						   a.risk_num,
							  (select 
										c.cd_nm 
								from tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
					FROM th_proces_risk_anay_pract_load_daily a , vw_process d, tc_risk_type b
					WHERE a.anys_ymd between #{anys_ymd} and #{end_anys_ymd}
					AND a.RISK_TYPE_ID='KIES202'
					AND a.procs_id = d.procs_id
					and a.risk_type_id = b.risk_type_id
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 리스트 > 일별  총건수  -->
	<select id="countPractProcsRiskDayMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_proces_risk_anay_pract_load_daily a , vw_process d, tc_risk_type b
			WHERE a.anys_ymd between #{anys_ymd} and #{end_anys_ymd}
			AND a.RISK_TYPE_ID='KIES202'
			AND a.procs_id = d.procs_id
			and a.risk_type_id = b.risk_type_id
		]]>
	</select>
	
	
	
	
	<!-- 위험도예측> 생산공정 > 24시간 예측  -->
	<select id="listPractProcsRiskHour24" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end qtime,
			    substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_proces_risk_anay_pract_load_hourly a , vw_process d, tc_risk_type b
		WHERE anys_ymdh between #{anys_ymdh} and #{end_anys_ymdh}
		AND a.RISK_TYPE_ID='KIES202'
		AND a.procs_id = d.procs_id
		]]>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		and a.risk_type_id = b.risk_type_id
		GROUP BY RISK_TYPE_ID, substr(anys_ymdh,1,8) , 
			case when floor(substr(anys_ymdh,9)/3) = 0 then '00'
				when floor(substr(anys_ymdh,9)/3) = 1 then '03'
				when floor(substr(anys_ymdh,9)/3) = 2 then '06'
				when floor(substr(anys_ymdh,9)/3) = 3 then '09'
				when floor(substr(anys_ymdh,9)/3) = 4 then '12'
				when floor(substr(anys_ymdh,9)/3) = 5 then '15'
				when floor(substr(anys_ymdh,9)/3) = 6 then '18'
				when floor(substr(anys_ymdh,9)/3) = 7 then '21' end
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 7일 예측 -->
	<select id="listPractProcsRiskDay7" resultType="hashmap">
		<![CDATA[
			SELECT
			   a.risk_type_id,
			   a.anys_ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
			FROM th_proces_risk_anay_pract_load_daily a , vw_process d
			WHERE a.anys_ymd between #{anys_ymd} and #{end_anys_ymd}
			AND a.RISK_TYPE_ID='KIES202'
			AND a.procs_id = d.procs_id
		]]>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
			GROUP BY a.risk_type_id,   a.anys_ymd
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 4주 예측 -->
	<select id="getPractProcsRiskDay7forWeek" resultType="hashmap">
		<![CDATA[
		SELECT
			   CONCAT(#{anys_ymd},'~', #{end_anys_ymd}) risk_dt,
			   a.risk_type_id,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_proces_risk_anay_pract_load_daily a , vw_process d
		WHERE anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES202'
		AND a.procs_id = d.procs_id
		]]>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
	</select>
</mapper>