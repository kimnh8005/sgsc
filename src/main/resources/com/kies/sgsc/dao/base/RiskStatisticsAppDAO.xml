<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kies.sgsc.dao.base.RiskStatisticsAppDAO">

	<!-- 최종조회일시 획득. -->
	<select id="lastDateYmdHI" resultType="string">
		<![CDATA[
			SELECT MAX(anys_ymdhi) as anys_ymdhi FROM th_facty_risk_anay_rtme_load_min
		]]>
	</select>
	
	<!-- <select id="lastDateEqmtYmdHI" resultType="string">
		<![CDATA[
			SELECT MAX(ANYS_YMDHI) as anys_ymdhi FROM th_eqmt_risk_anay_rtme_load_min
		]]>
	</select> -->
	
	<select id="lastDateYmdH" resultType="string">
		<![CDATA[
			SELECT MAX(anys_ymdh) as anys_ymdh FROM th_eqmt_risk_anay_rtme_load_hourly
		]]>
	</select>
	
	
	<!--  전체시설 실시간시설위험도 -->
	<select id="allRtimeFactyRateRate" resultType="hashmap">
		<![CDATA[
			SELECT
				a.anys_ymdhi
				,a.risk_step_cd
				,t.cd_nm risk_step_nm
				,a.risk_num
				,a.risk_unit
			FROM th_facty_risk_anay_rtme_load_min a , tc_common_code t
			WHERE a.anys_ymdhi = #{anys_ymdhi}
			AND a.risk_type_id = 'KIES101'  /* 통합시설위험도(실시간) */
			AND t.cd_grp_id='RISK_STEP_CD' 
			AND a.risk_step_cd = t.cd_id
			ORDER BY a.risk_num desc
			LIMIT 1
		]]>
	</select>

	<!-- 위험도높은 시설 -->
	<select id="listRiskHigtFacty" resultType="hashmap">
		<![CDATA[
			SELECT
				a.anys_ymdhi
		    	, a.facty_id
		      	,(SELECT 
					f.facty_nm 
				 FROM tb_facility f 
				 WHERE  f.facty_id = a.facty_id ) facty_nm
				, risk_step_cd 
				,(SELECT 
					c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd) risk_step_nm
				,risk_num
				,risk_unit
			FROM th_facty_risk_anay_rtme_load_min a
			WHERE anys_ymdhi = #{anys_ymdhi}
			AND risk_type_id = 'KIES101' /* 통합시설위험도(실시간) */
			ORDER BY risk_num DESC
			LIMIT 5
		]]>
	</select>
	
	
	
	<!-- 위험도높은 생산공정 -->
	<select id="listRiskHigtProcs" resultType="hashmap">
		<![CDATA[
			SELECT
				a.anys_ymdhi
				,b.facty_id as facty_id
				,b.facty_nm as facty_nm
		      	,b.procs_id as procs_id
		      	,b.procs_nm as procs_nm
				, risk_step_cd 
				,(SELECT 
						c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd) risk_step_nm
				,risk_num
				,risk_unit
			FROM th_proces_risk_anay_rtme_load_min a , vw_process b
			WHERE anys_ymdhi = #{anys_ymdhi}
			AND a.procs_id = b.procs_id
			AND risk_type_id = 'KIES102' /* 통합공정위험도(실시간) */
			ORDER BY risk_num DESC
			LIMIT 5
		]]>
	</select>
	
	
	
	<!-- 위험도높은 설비 > 시나리오 슬라이드 -->
	<select id="listRiskHigtEqmtForScno" resultType="hashmap">
		<![CDATA[
			SELECT
				ma.facty_nm as facty_nm
				,ma.eqmt_id
				,ma.eqmt_nm as eqmt_nm
				,ma.risk_step_nm
				,ma.risk_num
				,ma.risk_unit
				,ma.procs_id
				,ma.procs_nm
				,ma.facty_id
				,ifnull(sc.norl,0) NORL
				,ifnull(sc.care,0) CARE
				,ifnull(sc.warg,0) WARG
				,ifnull(sc.eror,0) EROR
			FROM (
			
		       	SELECT
				    a.anys_ymdhi
				    ,a.anys_sys_cd
				    ,a.risk_type_id
					,b.facty_id as facty_id
					,b.facty_nm as facty_nm
					,b.procs_id as procs_id
			      	,b.procs_nm as procs_nm
			      	,b.eqmt_id as eqmt_id
			      	,b.eqmt_nm as eqmt_nm
					, a.risk_step_cd 
					,(select 
							c.cd_nm 
					  from tc_common_code c 
					  WHERE CD_GRP_ID='RISK_STEP_CD' 
					  and c.cd_id = a.risk_step_cd) risk_step_nm
					,risk_num
					,risk_unit
				FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
				WHERE anys_ymdhi = #{anys_ymdhi}
				AND a.eqmt_id = b.eqmt_id 
				AND a.risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
			   ]]>
				<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
				<![CDATA[
				ORDER BY risk_num DESC
				LIMIT ${topidx}	
			
			) ma LEFT OUTER join	
				(
					SELECT
						a.anys_ymdhi,
					   a.factory_id,   
					   SUM(case when b.cd_add_itm='NORL' THEN 1 ELSE 0 END) norl,
					   SUM(case when b.cd_add_itm='CARE' THEN 1 ELSE 0 END) care,
					   SUM(case when b.cd_add_itm='WARG' THEN 1 ELSE 0 END) warg,
					   SUM(case when b.cd_add_itm='EROR' THEN 1 ELSE 0 END) eror
					FROM th_acdnt_scnrs_anay_load_min a, tc_common_code b
					WHERE a.anys_ymdhi = #{anys_ymdhi}
					AND a.anys_type_cd='AT1000'
					AND a.factory_hrrc_cd='FH3000'
					and a.anys_sys_cd='KIES'
					AND b.cd_grp_id='RISK_STEP_CD'
					AND a.risk_step_cd = b.cd_id
					GROUP BY a.anys_ymdhi,
				    a.factory_id 
				) sc
			ON ma.anys_ymdhi = sc.anys_ymdhi
			AND ma.eqmt_id = sc.factory_id
		]]>
	</select>
	
	
	<!-- 위험도높은 설비 -->
	<select id="listRiskHigtEqmt" resultType="hashmap">
		<![CDATA[
			SELECT
			    a.anys_ymdhi
			    ,a.anys_sys_cd
			    ,a.risk_step_cd
			    ,a.risk_type_id
				,b.facty_id as facty_id
				,b.facty_nm as facty_nm
				,b.procs_id as procs_id
		      	,b.procs_nm as procs_nm
		      	,b.eqmt_id as eqmt_id
		      	,b.eqmt_nm as eqmt_nm
				, risk_step_cd 
				,(select 
						c.cd_nm 
				  from tc_common_code c 
				  WHERE CD_GRP_ID='RISK_STEP_CD' 
				  and c.cd_id = a.risk_step_cd) risk_step_nm
				,risk_num
				,risk_unit
				${causequery}
			FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
			WHERE anys_ymdhi = #{anys_ymdhi}
			AND a.eqmt_id = b.eqmt_id 
			AND risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
			]]>
			<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
			<![CDATA[
			ORDER BY risk_num DESC
			LIMIT ${topidx}
		]]>
	</select>
	
	
	<!-- 위험도 높은 설비 의 이상원인 -->
	<select id="getRiskCauseEqmt" resultType="hashmap">
	<![CDATA[
		SELECT
			anys_ymdhi,
			eqmt_id,
			risk_type_id, 
			risk_step_cd ,
			(select 
					c.cd_nm 
			  from tc_common_code c 
			  WHERE cd_grp_id='RISK_STEP_CD' 
			  AND c.cd_id = a.risk_step_cd) risk_step_nm,
			risk_num
		FROM th_eqmt_risk_anay_rtme_load_min a
		WHERE anys_ymdhi = #{anys_ymdhi}
		AND anys_sys_cd = #{anys_sys_cd}
		AND risk_type_id = #{risk_type_id}
		AND eqmt_id = #{eqmt_id}
		ORDER BY risk_num DESC
		LIMIT 1
	]]>
	</select>
	
	
	<!-- 실시간위험도-설비분석데이터 -->
	<select id="listEqmtRiskCrig" resultType="hashmap">
	<![CDATA[
		SELECT
		   	a.risk_type_id,
		   	b.risk_type_nm,
	   		CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
		    SUBSTR(anys_ymdh,1,8) ymd,
		    (SELECT 
				c.cd_nm 
			FROM tc_common_code c 
			WHERE cd_grp_id='RISK_CLS_CD' 
			AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			 
			CASE WHEN b.use_yn='Y' THEN					    
					MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
					  (SELECT 
								c.cd_nm 
						FROM tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.risk_step_cd)))
			ELSE
				MIN(CASE WHEN IFNULL(a.risk_val,'') ='' THEN '정상' ELSE a.risk_val END)
			END	 risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
		AND a.anys_sys_cd='CRIG'
		AND a.risk_type_id = b.RISK_TYPE_ID
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, SUBSTR(anys_ymdh,1,8) , 
			CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END
	]]>
	</select>
	
	
	
	
	
	
	
		
	<!-- 실시간위험도  설비상세 (통합분석 , 센서 ,진단예지 , 영상)-->
	<select id="rtimeEqmtHistory" resultType="hashmap">
	<![CDATA[
SELECT
               a.ANYS_SYS_CD as anys_sys_cd,
			   a.risk_type_id,
			   b.risk_type_nm,
			   anys_ymdh,
			   substr(anys_ymdh,1,8) ymd,
			   substr(anys_ymdh,9,2) hour,
			    (SELECT 
					c.CD_NM 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='risk_cls_cd' 
				  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
				 case when b.use_yn='Y' then					    
						max(concat(lpad(risk_num,5,'0'), ':', 
						  (select 
									c.cd_nm 
							from sgscdb.tc_common_code c 
							WHERE cd_grp_id='risk_step_cd' 
							AND c.cd_id = a.risk_step_cd)))
					else
						Min(case when IFNULL(a.risk_val,'') ='' then '정상' ELSE a.risk_val end)
					end	 risk_rate,
			IFNULL((SELECT 
				  max(lpad(risk_num,5,'0')) rate
				  FROM sgscdb.tc_common_code c 
				  WHERE c.cd_grp_id='risk_cls_cd' 
				  AND c.cd_id = b.risk_cls_cd 
                  AND b.use_yn='Y'),0) risk_num, 
               (select 
									c.cd_nm 
							from sgscdb.tc_common_code c 
							WHERE cd_grp_id='risk_step_cd' 
							AND c.cd_id = a.risk_step_cd)risk_step_nm                 
		FROM sgscdb.th_eqmt_risk_anay_rtme_load_hourly a , sgscdb.tc_risk_type b
		WHERE anys_ymdh 
        between 
        (SELECT   DATE_FORMAT(date_add(STR_TO_DATE(MAX(anys_ymdhi), '%Y%m%d%H'), interval -7 day), '%Y%m%d%H') AS anys_ymdh FROM sgscdb.th_facty_risk_anay_rtme_load_min)
        AND (SELECT LEFT(MAX(anys_ymdhi), 10) AS lastymdH FROM sgscdb.th_facty_risk_anay_rtme_load_min)
       ]]>
       
       <choose>
			<when test = "CRIG">
				AND a.anys_sys_cd=#{anys_sys_cd} and a.risk_type_id='CRIG101		
			</when>
			<otherwise>			
				AND a.anys_sys_cd=#{anys_sys_cd}				
			</otherwise>			
		</choose>

    <![CDATA[	
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, anys_ymdh
		order by anys_ymdh desc,RISK_TYPE_ID                     
	]]>
	</select>
	
	

	
	
	
	<!-- 실시간위험도-설비분석데이터 이상원인 모두 포함 -->
	<select id="listEqmtRiskCrigApp" resultType="hashmap">
	<![CDATA[
SELECT
               a.ANYS_SYS_CD as anys_sys_cd,
			   a.risk_type_id,
			   b.risk_type_nm,
			   anys_ymdh,
			   substr(anys_ymdh,1,8) ymd,
			   substr(anys_ymdh,9,2) hour,
			    (SELECT 
					c.CD_NM 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='risk_cls_cd' 
				  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
				 case when b.use_yn='Y' then					    
						max(concat(lpad(risk_num,5,'0'), ':', 
						  (select 
									c.cd_nm 
							from sgscdb.tc_common_code c 
							WHERE cd_grp_id='risk_step_cd' 
							AND c.cd_id = a.risk_step_cd)))
					else
						Min(case when IFNULL(a.risk_val,'') ='' then '정상' ELSE a.risk_val end)
					end	 risk_rate,
				IFNULL	((SELECT 
				  max(lpad(risk_num,5,'0')) rate
				  FROM sgscdb.tc_common_code c 
				  WHERE c.cd_grp_id='risk_cls_cd' 
				  AND c.cd_id = b.risk_cls_cd 
                  AND b.use_yn='Y'),0) risk_num, 
               (select 
									c.cd_nm 
							from sgscdb.tc_common_code c 
							WHERE cd_grp_id='risk_step_cd' 
							AND c.cd_id = a.risk_step_cd)risk_step_nm
                    
		FROM sgscdb.th_eqmt_risk_anay_rtme_load_hourly a , sgscdb.tc_risk_type b
		WHERE anys_ymdh 
        between 
        (SELECT   DATE_FORMAT(date_add(STR_TO_DATE(MAX(anys_ymdhi), '%Y%m%d%H'), interval -7 day), '%Y%m%d%H') AS anys_ymdh FROM sgscdb.th_facty_risk_anay_rtme_load_min)
        AND (SELECT LEFT(MAX(anys_ymdhi), 10) AS lastymdH FROM sgscdb.th_facty_risk_anay_rtme_load_min)
        	]]>
		       <choose>
			<when test = "CRIG">
				AND a.anys_sys_cd=#{anys_sys_cd} and a.risk_type_id='CRIG101'		
			</when>
			<otherwise>			
				AND a.anys_sys_cd=#{anys_sys_cd}				
			</otherwise>			
		</choose>
		<![CDATA[
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, anys_ymdh
		order by anys_ymdh desc,RISK_TYPE_ID                     
	]]>
	</select>
	
	
	<!-- 실시간위험도 - 예지보전 위험도 -->
	<select id="listEqmtRiskPARTDB" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
			SUBSTR(a.anys_ymdh,1,8) anys_ymd,
			(SELECT 
				EQMT_NM 
			FROM tb_equipment j 
			WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
			a.eqmt_id, 
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.cd_nm 
			  FROM tc_common_code c 
			  WHERE cd_grp_id='RISK_CLS_CD' 
			  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			b.unit,			
			CASE WHEN b.risk_cls_cd = 'RC0001' THEN CONCAT(LPAD(a.risk_num,5,'0'),':',(SELECT 
															c.cd_nm 
													  FROM tc_common_code c 
													  WHERE cd_grp_id='RISK_STEP_CD' 
													  AND c.cd_id = a.risk_step_cd))
			WHEN use_yn='Y' THEN a.risk_num
			ELSE a.risk_val END risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='PARTDB'
		AND a.anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
		AND eqmt_id=#{eqmt_id}
	]]>
	</select>
	
	
	<!-- 실시간위험도 - 예지보전 위험도 앱용 -->
	<select id="listEqmtRiskPARTDBApp" resultType="hashmap">
	<![CDATA[
		SELECT
			SUBSTR(a.anys_ymdh,1,8) anys_ymd,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='PARTDB' and b.risk_cls_cd in (${risk_cls_cds})
		AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
		AND eqmt_id=#{eqmt_id}
		GROUP BY SUBSTR(a.anys_ymdh,1,8) , a.eqmt_id
		order by SUBSTR(a.anys_ymdh,1,8) desc 
		
	]]>
	</select>
	
	<!-- 실시간위험도 - 시나리오 예지보전 위험도 앱용 -->
	<select id="listEqmtRiskPARTDBAppforscno" resultType="hashmap">
	<![CDATA[
		SELECT
		   	a.risk_type_id,
		   	b.risk_type_nm,
	   		CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
		    SUBSTR(anys_ymdh,1,8) ymd,
		    (SELECT 
				c.cd_nm 
			FROM tc_common_code c 
			WHERE cd_grp_id='RISK_CLS_CD' 
			AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			 
			 CASE WHEN b.use_yn='Y' THEN					    
					MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
					  (SELECT 
								c.cd_nm 
						FROM tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.risk_step_cd)))
			ELSE
				MIN(CASE WHEN IFNULL(a.risk_val,'') ='' THEN '정상' ELSE a.risk_val END)
			END	 risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
		AND a.anys_sys_cd='PARTDB'
		AND a.risk_type_id='PART101'
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, SUBSTR(anys_ymdh,1,8) , 
			CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END
		
	]]>
	</select>
	
	<!-- 실시간위험도 - 시나리오 영상 위험도 앱용 -->
	<select id="listEqmtRiskKSECAppforscno" resultType="hashmap">
	<![CDATA[
		SELECT
		   	a.risk_type_id,
		   	b.risk_type_nm,
	   		CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
			WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
		    SUBSTR(anys_ymdh,1,8) ymd,
		    (SELECT 
				c.CD_NM 
			FROM tc_common_code c 
			WHERE cd_grp_id='RISK_CLS_CD' 
			AND c.cd_id = b.RISK_CLS_CD) risk_cls_nm,
			 
			CASE WHEN b.use_yn='Y' THEN					    
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
			  	(SELECT 
						c.cd_nm 
				FROM tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.risk_step_cd)))
			ELSE
				MIN(CASE WHEN IFNULL(a.risk_val,'') ='' THEN '정상' ELSE a.risk_val END)
			END	 risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE anys_ymdh between #{strt_anys_ymdh} AND ${anys_ymdh}
		AND a.anys_sys_cd='KSEC'
		AND a.risk_type_id='KSEC101'
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, SUBSTR(anys_ymdh,1,8) , 
			CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END
		
	]]>
	</select> 
	
	
	<!-- 실시간위험도 - 영상데이터 분석 위험도 -->
	<select id="listEqmtRiskKSEC" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
			SUBSTR(a.anys_ymdh,1,8) anys_ymd,
			(SELECT eqmt_nm FROM tb_equipment j WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
			a.eqmt_id,
			b.risk_type_nm,
			b.risk_cls_cd,
			b.unit,	
			(SELECT 
				c.cd_nm 
			FROM tc_common_code c 
			WHERE cd_grp_id='RISK_CLS_CD' 
			AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			CASE WHEN b.risk_cls_cd = 'RC0001' THEN CONCAT(LPAD(a.risk_num,5,'0'),':',(SELECT 
															c.cd_nm 
													  FROM tc_common_code c 
													  WHERE cd_grp_id='RISK_STEP_CD' 
													  AND c.cd_id = a.risk_step_cd))
			WHEN use_yn='Y' THEN a.risk_num
			ELSE a.risk_val END risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='KSEC'
		AND a.anys_ymdh =#{anys_ymdh}
		AND eqmt_id=#{eqmt_id}
	]]>
	</select>
	
	
	<!-- 실시간위험도 - 영상데이터 분석 위험도 앱용 -->
	<select id="listEqmtRiskKSECApp" resultType="hashmap">
	<![CDATA[
		SELECT
			SUBSTR(a.anys_ymdh,1,8) anys_ymd,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='KSEC'  and b.risk_cls_cd in (${risk_cls_cds}) 
		AND a.anys_ymdh between #{strt_anys_ymdh} AND #{anys_ymdh}
		AND eqmt_id=#{eqmt_id}
		GROUP BY substr(a.anys_ymdh,1,8), a.eqmt_id
		ORDER by substr(a.anys_ymdh,1,8) desc
	]]>
	</select>

	
	<!-- 위험도 예측 - 예측위험도 높은 설비 -->
	<select id="listPractEqmtRiskTop5" resultType="hashmap">
	<![CDATA[
		SELECT 
			b.facty_id
			,b.facty_nm
			,b.procs_id
			,b.procs_nm
			,b.eqmt_id
			,b.eqmt_nm
			,a.risk_step_cd
			, (select 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd) risk_step_nm
			,a.risk_num
			,a.risk_unit
		FROM th_eqmt_risk_anay_pract_load_hourly a, vw_equipment b
		WHERE anys_ymdh BETWEEN  #{anys_ymdh} and #{end_anys_ymdh}
		AND a.eqmt_id= b.eqmt_id
		ORDER BY risk_num DESC
		LIMIT 5
	]]>
	</select>
	
		
	<!--위험도 예측>설비예측> 리스트> 24시간   -->
	<select id="pagePractEqmtRiskHourMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
		      			   d.eqmt_id as eqmt_id,
		      			   d.eqmt_nm as eqmt_nm,
						   a.anys_ymdh,
						   a.risk_num,
							  (SELECT 
										c.cd_nm 
								FROM tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.risk_step_cd) risk_step_nm
					FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
					WHERE a.anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
					AND a.risk_type_id='KIES203'
					AND a.eqmt_id = d.eqmt_id
					AND a.risk_type_id = b.risk_type_id
				]]>
					<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
					<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
					<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
				<![CDATA[	
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!--위험도 예측>설비예측> 24시간 총건수  -->
	<select id="countPractEqmtRiskHourMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
			WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
			and a.risk_type_id='KIES203'
			AND a.eqmt_id = d.eqmt_id
			and a.risk_type_id = b.risk_type_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
	</select>
	
	
	<!--위험도 예측>설비예측> 리스트> 일간시간   -->
	<select id="pagePractEqmtRiskDayMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
		      			   d.eqmt_id as eqmt_id,
		      			   d.eqmt_nm as eqmt_nm,
						   a.anys_ymd,
						   a.risk_num,
						   (SELECT 
									c.cd_nm 
							FROM tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
					FROM th_eqmt_risk_anay_pract_load_daily a , vw_equipment d, tc_risk_type b
					WHERE a.anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
					AND a.risk_type_id='KIES203'
					AND a.eqmt_id = d.eqmt_id
					AND a.risk_type_id = b.risk_type_id
				]]>
					<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
					<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
					<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
				<![CDATA[	
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!--위험도 예측>설비예측> 일간 총건수  -->
	<select id="countPractEqmtRiskDayMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_eqmt_risk_anay_pract_load_daily a , vw_equipment d, tc_risk_type b
			WHERE a.anys_ymd BETWEEN #{anys_ymd} AND #{end_anys_ymd}
			AND a.risk_type_id='KIES203'
			AND a.eqmt_id = d.eqmt_id
			AND a.risk_type_id = b.risk_type_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
	</select>
	
	
	
	
	<!--위험도 예측>설비예측> 24시간 예측  -->
	<select id="listPractEqmtRiskHour24" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			   a.anys_ymdh,
			   SUBSTR(anys_ymdh,1,8) ymd,
			  	SUBSTR(anys_ymdh,9) qtime,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE anys_ymdh BETWEEN #{anys_ymdh} AND #{end_anys_ymdh}
		AND a.risk_type_id='KIES203'
		AND a.eqmt_id = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.risk_type_id = b.risk_type_id
		GROUP BY a.anys_ymdh,a.risk_type_id
		ORDER by a.anys_ymdh desc
		]]>
	</select>
	
	<!-- 7일 예측 -->
	<select id="listPractEqmtRiskDay7" resultType="hashmap">
		<![CDATA[
			SELECT
				   a.risk_type_id,
				   b.risk_type_nm,			  	
				    SUBSTR(anys_ymdh,1,8) ymd,
					MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
					  (SELECT 
								c.cd_nm 
						FROM tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.RISK_STEP_CD))) risk_rate
			FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
			WHERE anys_ymdh BETWEEN  #{anys_ymdh} AND #{end_anys_ymdh}
			AND a.risk_type_id='KIES203'
			AND a.eqmt_id = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
			AND a.risk_type_id = b.risk_type_id
			GROUP BY risk_type_id, substr(anys_ymdh,1,8) 
			ORDER by  substr(anys_ymdh,1,8) desc
		]]>
	</select>
	
	<!-- 4주 예측 -->
	<select id="getPractEqmtRiskDay7forWeek" resultType="hashmap">
		<![CDATA[
			SELECT
			   CONCAT(SUBSTR(#{anys_ymdh},1,8),'~', SUBSTR(#{end_anys_ymdh},1,8)) risk_dt,
			   a.risk_type_id,
			   b.risk_type_nm,  	
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
		AND a.risk_type_id='KIES203'
		AND a.eqmt_id = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.risk_type_id = b.risk_type_id
		GROUP BY risk_type_id
		]]>
	</select>
	
 	
 	
 	<!-- 위험도이력 생산공정 조회-->
	<select id="listRisktProcsHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdhi
			,b.facty_id as facty_id
			,b.facty_nm as facty_nm
	      	,b.procs_id as procs_id
	      	,b.procs_nm as procs_nm
			, risk_step_cd 
			,(SELECT 
					c.cd_nm 
			  FROM tc_common_code c 
			  WHERE cd_grp_id='RISK_STEP_CD' 
			  AND c.cd_id = a.RISK_STEP_CD) risk_step_nm
			,risk_num
			,risk_unit
		FROM th_proces_risk_anay_rtme_load_min a , vw_process b
		WHERE anys_ymdhi between #{anys_ymdhi} AND #{end_anys_ymdhi}
		AND a.procs_id = b.procs_id
		AND risk_type_id = 'KIES102' 
		]]>
		
		<if test='risk_step_cd.size !=0'>
			AND risk_step_cd IN (SELECT 
						g.cd_id 
				  FROM tc_common_code g 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND cd_add_itm IN 			
			   <foreach collection="risk_step_cd" item="value"  open="(" close=")" separator=",">
		            #{value}
		        </foreach>
		     )
		 </if>
		 <![CDATA[
		ORDER BY risk_num DESC
		]]>
	</select>
	
	
	<!-- 위험도이력 생산공정 조회 페이징 -->
	<select id="pageRisktProcsHistory" resultType="hashmap">
	<![CDATA[
		SELECT * FROM ( 
			SELECT 
				@rownum:=@rownum+1 RO, 
				A.* 
			FROM 
			(
				SELECT
					a.anys_ymdhi
					,b.facty_id as facty_id
					,b.facty_nm as facty_nm
			      	,b.procs_id as procs_id
			      	,b.procs_nm as procs_nm
					, risk_step_cd 
					,(SELECT 
							c.cd_nm 
					  FROM tc_common_code c 
					  WHERE cd_grp_id='RISK_STEP_CD' 
					  AND c.cd_id = a.risk_step_cd) risk_step_nm
					,risk_num
					,risk_unit
				FROM th_proces_risk_anay_rtme_load_min a , vw_process b
				WHERE anys_ymdhi between #{anys_ymdhi} and #{end_anys_ymdhi}
				AND a.procs_id = b.procs_id
				AND risk_type_id = 'KIES102' 
				]]>
				
				<if test='risk_step_cd.size !=0'>
					AND risk_step_cd IN (SELECT 
								g.cd_id 
						  FROM tc_common_code g 
						  WHERE cd_grp_id='RISK_STEP_CD' 
						  AND cd_add_itm IN 			
					   <foreach collection="risk_step_cd" item="value"  open="(" close=")" separator=",">
				            #{value}
				        </foreach>
				     )
				 </if>
				 <![CDATA[
				ORDER BY risk_num DESC
				) A,
				(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!-- 위험도이력 생산공정 조회 건수 -->
	<select id="countRisktProcsHistory" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_proces_risk_anay_rtme_load_min a , vw_process b
			WHERE anys_ymdhi between #{anys_ymdhi} and #{end_anys_ymdhi}
			AND a.procs_id = b.procs_id
			AND risk_type_id = 'KIES102'
		]]>
		<if test='risk_step_cd.size !=0'>
			AND risk_step_cd IN (SELECT 
						g.CD_ID 
				  FROM tc_common_code g 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND cd_add_itm IN 			
			   <foreach collection="risk_step_cd" item="value"  open="(" close=")" separator=",">
		            #{value}
		        </foreach>
		     )
		 </if>
	</select>
	
	
	
	<!-- 위험도이력 생산공정 상세 3시간-->
	<select id="listRiskProcs3HourHistory" resultType="hashmap">
		<![CDATA[		
		SELECT
			a.risk_type_id,
			b.risk_type_nm,
			a.anys_ymdh,
			SUBSTR(a.anys_ymdh,9) qtime,
			SUBSTR(a.anys_ymdh,1,8) ymd,
			MAX(concat(lpad(risk_num,5,'0'), ':', 
				(SELECT 
						c.cd_nm 
				FROM tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_proces_risk_anay_rtme_load_hourly a , vw_process d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		and a.risk_type_id='KIES102'
		AND a.procs_id = d.procs_id	
		AND a.procs_id = #{procs_id}
		AND a.risk_type_id = b.risk_type_id
		GROUP BY risk_type_id, a.anys_ymdh
		order by a.anys_ymdh desc
		]]>
	</select>
	
	<!-- 위험도이력 생산공정 상세 일별 -->
	<select id="listRiskProcsDayHistory" resultType="hashmap">
		<![CDATA[		
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,			  
			   SUBSTR(anys_ymdh,1,8) ymd,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_proces_risk_anay_rtme_load_hourly a , vw_process d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} AND #{end_anys_ymd}
		and a.risk_type_id='KIES102'
		AND a.procs_id = d.procs_id	
		AND a.procs_id = #{procs_id}
		AND a.risk_type_id = b.risk_type_id
		GROUP BY risk_type_id, substr(anys_ymdh,1,8) 
		ORDER BY substr(anys_ymdh,1,8)  DESC
		]]>
	</select>
	
	
	<!-- 위험도이력 설비별 상세 3시간-->
	<select id="listRiskEqmt3HourHistory" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			   a.anys_ymdh,
			  	substr(anys_ymdh,9) qtime,
			    substr(anys_ymdh,1,8) ymd,
				max(concat(lpad(risk_num,5,'0'), ':', 
				  (select 
							c.cd_nm 
					from tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , vw_equipment d, tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.risk_type_id='KIES103'
		AND a.eqmt_id = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.risk_type_id = b.risk_type_id
		GROUP BY risk_type_id, substr(anys_ymdh,1,8) , a.anys_ymdh
		order by a.anys_ymdh desc
		]]>
	</select>
	
	<!-- 위험도이력 설비별 상세 일별-->
	<select id="listRiskEqmtDayHistory" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			   anys_ymd,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_eqmt_risk_anay_pract_load_daily a , vw_equipment d, tc_risk_type b
		WHERE a.anys_ymd BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.risk_type_id='KIES203'
		AND a.eqmt_id = d.eqmt_id
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND d.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		AND a.risk_type_id = b.risk_type_id
		GROUP BY risk_type_id,a.anys_ymd
		ORDER BY anys_ymd DESC
		]]>
	</select>
	
	
	
	<!-- 위험도이력 - 센서데이터 분석 위험도 -->
	<select id="listRiskCRIG3HourHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			substr(anys_ymdh,1,8) ymd,
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.cd_nm 
			  FROM tc_common_code c 
			  WHERE cd_grp_id='RISK_CLS_CD' 
			  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			b.unit,			
			CASE WHEN floor(substr(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN floor(substr(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN floor(substr(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN floor(substr(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN floor(substr(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN floor(substr(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN floor(substr(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN floor(substr(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='CRIG'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY  SUBSTR(anys_ymdh,1,8) ,risk_type_id, b.risk_cls_cd ,
			CASE WHEN floor(substr(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN floor(substr(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN floor(substr(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN floor(substr(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN floor(substr(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN floor(substr(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN floor(substr(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN floor(substr(anys_ymdh,9)/3) = 7 THEN '21' END
		ORDER BY substr(anys_ymdh,1,8) ,risk_type_id
	]]>
	</select>
	
	
	<!-- 위험도이력 - 센서데이터 분석 위험도 앱용 소트-->
	<select id="listRiskCRIG3HourHistoryApp" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
			SUBSTR(anys_ymdh,1,8) ymd,
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
				c.cd_nm 
			FROM tc_common_code c 
			WHERE cd_grp_id='RISK_CLS_CD' 
			AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			b.unit,			
			SUBSTR(anys_ymdh,9) qtime,
			MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				(SELECT 
					c.cd_nm 
				FROM tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='CRIG'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{strt_anys_ymd} AND #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY  a.anys_ymdh,risk_type_id, b.risk_cls_cd 
		ORDER BY a.anys_ymdh DESC
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 예지보전 위험도 -->
	<select id="listRiskPARTDB3HourHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			SUBSTR(a.anys_ymdh,1,8) ymd,
			a.eqmt_id, 
			a.risk_type_id , 
			b.risk_type_nm, 
			b.risk_cls_cd,
			(SELECT 
					c.cd_nm 
			  FROM tc_common_code c 
			  WHERE cd_grp_id='RISK_CLS_CD' 
			  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			b.unit,			
			MAX(CASE WHEN b.risk_cls_cd = 'RC0001' then CONCAT(lpad(a.risk_step_lvl,2,0) ,':',(SELECT 
															c.cd_nm 
													  FROM tc_common_code c 
													  WHERE cd_grp_id='RISK_STEP_CD' 
													  AND c.cd_id = a.risk_step_cd))
			WHEN use_yn='Y' THEN a.risk_num
			ELSE a.risk_val END) risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='PARTDB'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{anys_ymd} AND #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY SUBSTR(a.anys_ymdh,1,8) ,a.risk_type_id, b.risk_cls_cd
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 예지보전 위험도 앱용-->
	<select id="listRiskPARTDB3HourHistoryApp" resultType="hashmap">
	<![CDATA[
		SELECT
			SUBSTR(a.anys_ymdh,1,8) ymd,
			a.eqmt_id 
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='PARTDB'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{anys_ymd} AND #{end_anys_ymd}
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY SUBSTR(a.anys_ymdh,1,8) ,a.eqmt_id
		order by SUBSTR(a.anys_ymdh,1,8) DESC
	]]>
	</select>
	
	<!-- 위험도 이력 - 예지보전 위험도 앱용 시나리오 -->
	<select id="listRiskPARTDB3HourHistoryAppforscno" resultType="hashmap">
	<![CDATA[	
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
			    SUBSTR(anys_ymdh,1,8) ymd,
			    (SELECT 
					c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
				 
				 CASE WHEN b.use_yn='Y' then					    
						MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
						  (SELECT 
									c.cd_nm 
							FROM tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.risk_step_cd)))
					ELSE
						MIN(CASE WHEN IFNULL(a.RISK_VAL,'') ='' THEN '정상' ELSE a.risk_val END)
					END	 risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , tc_risk_type b
		WHERE SUBSTR(anys_ymdh,1,8) BETWEEN #{anys_ymd} AND #{end_anys_ymd}
		AND a.anys_sys_cd='PARTDB'
		AND a.risk_type_id='PART101'
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, SUBSTR(anys_ymdh,1,8) , 
			CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END			
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 영상데이터 분석 위험도 시나리오 -->
	<select id="listRiskKSEC3HourHistoryAppforscno" resultType="hashmap">
	<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
			    SUBSTR(anys_ymdh,1,8) ymd,
			    (SELECT 
					c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
				 
				 CASE WHEN b.use_yn='Y' THEN					    
						MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
						  (SELECT 
									c.cd_nm 
							FROM tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.risk_step_cd)))
					ELSE
						MIN(CASE WHEN IFNULL(a.risk_val,'') ='' THEN '정상' ELSE a.risk_val END)
					END	 risk_rate
		FROM th_eqmt_risk_anay_pract_load_hourly a , tc_risk_type b
		WHERE substr(anys_ymdh,1,8) between #{anys_ymd} and #{end_anys_ymd}
		AND a.anys_sys_cd='KSEC'
		AND a.risk_type_id='KSEC101'
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, SUBSTR(anys_ymdh,1,8) , 
			CASE WHEN FLOOR(substr(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 7 THEN '21' END
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 영상데이터 분석 위험도 -->
	<select id="listRiskKSEC3HourHistory" resultType="hashmap">
	<![CDATA[
		SELECT
			SUBSTR(anys_ymdh,1,8) ymd,
			(SELECT eqmt_nm FROM tb_equipment j WHERE j.eqmt_id =a.eqmt_id) eqmt_nm,
			a.eqmt_id,
			a.risk_type_id,
			b.risk_type_nm,
			b.risk_cls_cd,
			b.unit,	
			(SELECT 
					c.cd_nm 
			  FROM tc_common_code c 
			  WHERE cd_grp_id='RISK_CLS_CD' 
			  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
			MAX(CONCAT(LPAD(risk_num,5,'0'), ':', (SELECT 
					c.cd_nm 
			  FROM tc_common_code c 
			  WHERE CD_GRP_ID='RISK_STEP_CD' 
			  AND c.cd_id = a.risk_step_cd) ) )risk_value
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='KSEC'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{anys_ymd} AND #{end_anys_ymd}
		AND eqmt_id=#{eqmt_id}
		GROUP BY SUBSTR(anys_ymdh,1,8),a.risk_type_id,b.risk_cls_cd
	]]>
	</select>
	
	
	<!-- 위험도 이력 - 영상데이터 분석 위험도 앱용 -->
	<select id="listRiskKSEC3HourHistoryApp" resultType="hashmap">
	<![CDATA[
		SELECT
			SUBSTR(anys_ymdh,1,8) ymd,
			a.eqmt_id
			${groupQuery}
		FROM th_eqmt_risk_anay_rtme_load_hourly a , tc_risk_type b
		WHERE a.risk_type_id = b.risk_type_id
		AND a.anys_sys_cd='KSEC'
		AND SUBSTR(anys_ymdh,1,8) BETWEEN #{anys_ymd} AND #{end_anys_ymd}
		AND eqmt_id=#{eqmt_id}
		GROUP BY substr(anys_ymdh,1,8),a.eqmt_id
		ORDER by substr(anys_ymdh,1,8) desc
	]]>
	</select>
	
	
		<!-- 위험도 이력  설비 상세 위험도별 리스트-->
	<select id= "listToEqmtRiskAnalysisHistoryByAnlySysCd" resultType="hashmap">
	<![CDATA[
				SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END qtime,
			    SUBSTR(anys_ymdh,1,8) ymd,
			    MAX(LPAD(risk_num,5,'0')) risk_num,
			    MAX((SELECT 
									c.cd_nm 
							FROM sgscdb.tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.risk_step_cd)) risk_step_nm,
			    (SELECT 
					c.cd_nm 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_CLS_CD' 
				  AND c.cd_id = b.risk_cls_cd) risk_cls_nm,
				 
				 CASE WHEN b.use_yn='Y' THEN					    
						MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
						  (SELECT 
									c.cd_nm 
							FROM sgscdb.tc_common_code c 
							WHERE cd_grp_id='RISK_STEP_CD' 
							AND c.cd_id = a.risk_step_cd)))
					ELSE
						MIN(CASE WHEN IFNULL(a.risk_val,'') ='' THEN '정상' ELSE a.risk_val END)
					END	 risk_rate
		FROM sgscdb.th_eqmt_risk_anay_rtme_load_hourly a , sgscdb.tc_risk_type b
		WHERE substr(anys_ymdh,1,8) between #{start_ymd} and #{end_ymd}
		AND a.anys_sys_cd=#{anys_sys_cd} 
		AND a.risk_type_id in (${risk_type_id})
		AND a.risk_type_id = b.risk_type_id
		AND a.eqmt_id = #{eqmt_id}
		GROUP BY risk_type_id, SUBSTR(anys_ymdh,1,8) ,
		   CASE WHEN FLOOR(substr(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(substr(anys_ymdh,9)/3) = 7 THEN '21' END;
	]]>
	</select>
	
	
	
	<!-- 가스위험성 제안 설비 -->
	<select id="listProposeGasRisk" resultType="hashmap">
		<![CDATA[
			SELECT
			    a.anys_ymdhi
			    ,a.anys_sys_cd
			    ,a.risk_step_cd
			    ,a.risk_type_id
				,b.facty_id as facty_id
				,b.facty_nm as facty_nm
				,b.procs_id as procs_id
		      	,b.procs_nm as procs_nm
		      	,b.eqmt_id as eqmt_id
		      	,b.eqmt_nm as eqmt_nm
				, risk_step_cd 
				,(SELECT 
						c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd) risk_step_nm
				,risk_num
				,risk_unit
			FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
			WHERE SUBSTR(a.anys_ymdhi,1,8) BETWEEN #{strt_anys_ymd} AND #{end_anys_ymd}
			and a.eqmt_id = b.eqmt_id 
			AND risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
			]]>
			<if test='eqmt_id != null and eqmt_id != ""'>AND a.eqmt_id = #{eqmt_id}</if>
			<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
			<if test='facty_id != null and facty_id != ""'>AND b.facty_id = #{facty_id}</if>
		<![CDATA[	
			ORDER BY risk_num DESC
		]]>
	</select>
	
	
	<select id="pageProposeGasRisk" resultType="hashmap">
		<![CDATA[
			SELECT * FROM ( 
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
					    a.anys_ymdhi
					    ,a.anys_sys_cd
					    ,a.risk_step_cd
					    ,a.risk_type_id
						,b.facty_id as facty_id
						,b.facty_nm as facty_nm
						,b.procs_id as procs_id
				      	,b.procs_nm as procs_nm
				      	,b.eqmt_id as eqmt_id
				      	,b.eqmt_nm as eqmt_nm
						,(select 
								c.cd_nm 
						  from tc_common_code c 
						  WHERE cd_grp_id='RISK_STEP_CD' 
						  and c.cd_id = a.risk_step_cd) risk_step_nm
						,risk_num
						,risk_unit
					FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
					WHERE a.anys_ymdhi BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
					and a.eqmt_id = b.eqmt_id 
					AND risk_type_id = 'KIES103' /* 통합설비위험도(실시간) */
		]]>
					<if test='eqmt_id != null and eqmt_id != ""'>AND a.eqmt_id = #{eqmt_id}</if>
					<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
					<if test='facty_id != null and facty_id != ""'>AND b.facty_id = #{facty_id}</if>
		<![CDATA[
					/*ORDER BY update_date DESC*/
				) A,
				(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>

	<select id="countProposeGasRisk" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_eqmt_risk_anay_rtme_load_min a , vw_equipment b
			WHERE substr(a.anys_ymdhi,1,8) BETWEEN #{strt_anys_ymd} and #{end_anys_ymd}
			AND a.eqmt_id = b.eqmt_id 
			AND risk_type_id = 'KIES103'
		]]>
		<if test='eqmt_id != null and eqmt_id != ""'>AND a.eqmt_id = #{eqmt_id}</if>
		<if test='procs_id != null and procs_id != ""'>AND b.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND b.facty_id = #{facty_id}</if>
	</select>
	
	
	
	
	<!-- 위험도예측>시설 전체 -->
	<select id="getPractFactyRiskAll" resultType="hashmap">
	<![CDATA[
		SELECT
			MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
			  (SELECT 
						c.cd_nm 
				FROM tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_facty_risk_anay_pract_load_daily a
		WHERE anys_ymd BETWEEN  #{anys_ymd} and #{end_anys_ymd}
		AND a.risk_type_id='KIES201'
	]]>
	</select>
	
	<!-- 위험도예측>시설24시간 예측  -->
	<select id="listPractFactyRiskHour24" resultType="hashmap">
		<![CDATA[
		SELECT
		    a.risk_type_id,	
		    anys_ymdh,		
			substr(anys_ymdh,9) qtime,
		    substr(a.anys_ymdh,1,8) ymd,	   
			max(concat(lpad(a.risk_num,5,'0'), ':', 
			  (select 
						c.cd_nm 
				from tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.RISK_STEP_CD))) risk_rate
		FROM  th_facty_risk_anay_pract_load_hourly a
		WHERE anys_ymdh BETWEEN #{anys_ymdh} and #{end_anys_ymdh}
		AND a.risk_type_id='KIES201'
		GROUP BY risk_type_id, anys_ymdh
		ORDER by anys_ymdh desc
		]]>
	</select>
	
	<!-- 위험도예측>시설7일 예측 -->
	<select id="listPractFactyRiskDay7" resultType="hashmap">
		<![CDATA[
		SELECT
		   a.risk_type_id,
		   a.anys_ymd,
			MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
			  (SELECT 
						c.cd_nm 
				FROM tc_common_code c 
				WHERE cd_grp_id='RISK_STEP_CD' 
				AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_facty_risk_anay_pract_load_daily a
		WHERE anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
		AND a.risk_type_id='KIES201'
		GROUP BY a.risk_type_id,   a.anys_ymd
		ORDER by a.anys_ymd desc
		]]>
	</select>
	
	<!-- 위험도예측>시설4주 예측 -->
	<select id="getPractFactyRiskDay7forWeek" resultType="hashmap">
		<![CDATA[
		SELECT
			   CONCAT(#{anys_ymd},'~', #{end_anys_ymd}) risk_dt,
			   a.risk_type_id,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_facty_risk_anay_pract_load_daily a 
		WHERE anys_ymd BETWEEN #{anys_ymd} and #{end_anys_ymd}
		AND a.risk_type_id='KIES201'
		]]>
	</select>
	
	
	<!-- 위험도예측> 생산공정 > 리스트 > 24시간  페이징-->
	<select id="pagePractProcsRiskHourMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
						   a.anys_ymdh,
						   SUBSTR(a.anys_ymdh,1,8) anys_ymd,
						   a.risk_num,
							  (SELECT 
										c.cd_nm 
								FROM tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.risk_step_cd) risk_step_nm
					FROM th_proces_risk_anay_pract_load_hourly a , vw_process d, tc_risk_type b
					WHERE a.anys_ymdh between #{anys_ymdh} and #{end_anys_ymdh}
					AND a.RISK_TYPE_ID='KIES202'
					AND a.procs_id = d.procs_id
					AND a.risk_type_id = b.risk_type_id
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 24시간 리스트 총건수  -->
	<select id="countPractProcsRiskHourMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_proces_risk_anay_pract_load_hourly a , vw_process d, tc_risk_type b
			WHERE a.anys_ymdh between #{anys_ymdh} and #{end_anys_ymdh}
			AND a.RISK_TYPE_ID='KIES202'
			AND a.procs_id = d.procs_id
			and a.risk_type_id = b.risk_type_id
		]]>
	</select>
	
	
	<!-- 위험도예측> 생산공정 > 리스트 > 일별  페이징-->
	<select id="pagePractProcsRiskDayMax" resultType="hashmap">
		<![CDATA[
			SELECT * FROM (  
				SELECT 
					@rownum:=@rownum+1 RO, 
					A.* 
				FROM 
				(
					SELECT
						   a.risk_type_id,
						   b.risk_type_nm,	
						   d.procs_id as procs_id,
		      			   d.procs_nm as procs_nm,	
						   a.anys_ymd,
						   a.risk_num,
							  (SELECT 
										c.cd_nm 
								FROM tc_common_code c 
								WHERE cd_grp_id='RISK_STEP_CD' 
								AND c.cd_id = a.risk_step_cd) risk_step_nm
					FROM th_proces_risk_anay_pract_load_daily a , vw_process d, tc_risk_type b
					WHERE a.anys_ymd between #{anys_ymd} AND #{end_anys_ymd}
					AND a.risk_type_id='KIES202'
					AND a.procs_id = d.procs_id
					and a.risk_type_id = b.risk_type_id
					ORDER BY a.risk_num DESC
				) A,
					(SELECT @rownum:=0) TMP
			) A
			LIMIT  ${startRow},${endRow}
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 리스트 > 일별  총건수  -->
	<select id="countPractProcsRiskDayMax" resultType="int">
		<![CDATA[
			SELECT
			    COUNT(1)
			FROM th_proces_risk_anay_pract_load_daily a , vw_process d, tc_risk_type b
			WHERE a.anys_ymd between #{anys_ymd} AND #{end_anys_ymd}
			AND a.risk_type_id='KIES202'
			AND a.procs_id = d.procs_id
			and a.risk_type_id = b.risk_type_id
		]]>
	</select>
	
	
	
	
	<!-- 위험도예측> 생산공정 > 24시간 예측  -->
	<select id="listPractProcsRiskHour24" resultType="hashmap">
		<![CDATA[
		SELECT
			   a.risk_type_id,
			   b.risk_type_nm,
			  	CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' end qtime,
			    SUBSTR(anys_ymdh,1,8) ymd,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_proces_risk_anay_pract_load_hourly a , vw_process d, tc_risk_type b
		WHERE anys_ymdh between #{anys_ymdh} AND #{end_anys_ymdh}
		AND a.RISK_TYPE_ID='KIES202'
		AND a.procs_id = d.procs_id
		]]>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
		and a.risk_type_id = b.risk_type_id
		GROUP BY risk_type_iD, SUBSTR(anys_ymdh,1,8) , 
			CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END
		ORDER BY SUBSTR(anys_ymdh,1,8) desc, 
		    CASE WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 0 THEN '00'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 1 THEN '03'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 2 THEN '06'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 3 THEN '09'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 4 THEN '12'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 5 THEN '15'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 6 THEN '18'
				WHEN FLOOR(SUBSTR(anys_ymdh,9)/3) = 7 THEN '21' END DESC
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 7일 예측 -->
	<select id="listPractProcsRiskDay7" resultType="hashmap">
		<![CDATA[
			SELECT
			   a.risk_type_id,
			   a.anys_ymd,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
			FROM th_proces_risk_anay_pract_load_daily a , vw_process d
			WHERE a.anys_ymd between #{anys_ymd} AND #{end_anys_ymd}
			AND a.risk_type_id='KIES202'
			AND a.procs_id = d.procs_id
		]]>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
		<![CDATA[
			GROUP BY a.risk_type_id,   a.anys_ymd
			ORDER by a.anys_ymd desc
		]]>
	</select>
	
	<!-- 위험도예측> 생산공정 > 4주 예측 -->
	<select id="getPractProcsRiskDay7forWeek" resultType="hashmap">
		<![CDATA[
		SELECT
			   CONCAT(#{anys_ymd},'~', #{end_anys_ymd}) risk_dt,
			   a.risk_type_id,
				MAX(CONCAT(LPAD(risk_num,5,'0'), ':', 
				  (SELECT 
							c.cd_nm 
					FROM tc_common_code c 
					WHERE cd_grp_id='RISK_STEP_CD' 
					AND c.cd_id = a.risk_step_cd))) risk_rate
		FROM th_proces_risk_anay_pract_load_daily a , vw_process d
		WHERE anys_ymd BETWEEN #{anys_ymd} AND #{end_anys_ymd}
		AND a.RISK_TYPE_ID='KIES202'
		AND a.procs_id = d.procs_id
		]]>
		<if test='procs_id != null and procs_id != ""'>AND d.procs_id = #{procs_id}</if>
		<if test='facty_id != null and facty_id != ""'>AND d.facty_id = #{facty_id}</if>
	</select>
	
	<!-- 사고시나리오 실시간 시분 팝업- 위험율 (통합위험율: KIES01, KSEC01:위험율,  PARTDB:고장확율, CRIG:발생확율
		anys_type_cd- AT1000:실시간  AT2000:예측 
		factory_hrrc_cd : 'FH1000':계통(시설), FH1000:FH3000 FH2000:시설(공정)
		factory_id : 각 아이디
	-->
	<select id="lisScnrsHourlyDesc" resultType="hashmap">
	<![CDATA[
		SELECT
			a.anys_ymdh,
		    a.factory_id ,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc,
			MAX(lpad(a.risk_num,5,'0')) as risk_num,
			MAX((SELECT 
					c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) as risk_step_nm,
			MAX((SELECT 
					c.CD_ID
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) as risk_step_id,		  	
			MAX(  concat(lpad(a.risk_num,5,'0'),':',(SELECT 
					c.cd_nm 
				  FROM tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) ) as risk_num_nm
			
		FROM th_acdnt_scnrs_anay_load_hourly a, tc_common_code b, tc_acdent_scnrs c
		WHERE a.anys_ymdh = #{anys_ymdh}
		AND b.cd_grp_id='RISK_STEP_CD'
		AND a.risk_step_cd = b.CD_ID
		AND a.anys_type_cd= #{anys_type_cd}    
		AND a.factory_hrrc_cd= IFNULL(#{factory_hrrc_cd}, a.factory_hrrc_cd)
		AND a.factory_id=#{factory_id}
		AND a.scen_id = c.scen_id
		GROUP BY a.anys_ymdh,
		   a.factory_id,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc 
	]]>
	</select>
		
	<select id="commLisScnrsDailyDesc" resultType="hashmap">
	<![CDATA[	      
        SELECT
			a.anys_type_cd,
			a.anys_ymd,
		    a.factory_id ,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc,
			MAX(lpad(a.risk_num,5,'0')) as risk_num,
			MAX((SELECT 
					c.cd_nm 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) as risk_step_nm,
			MAX((SELECT 
					c.CD_ID
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) as risk_step_id,		  	
			MAX(  concat(lpad(a.risk_num,5,'0'),':',(SELECT 
					c.cd_nm 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) ) as risk_num_nm
             
			
		FROM sgscdb.th_acdnt_scnrs_anay_load_daily a, sgscdb.tc_common_code b, sgscdb.tc_acdent_scnrs c
		WHERE a.anys_ymd = #{anys_ymd}
        AND a.anys_type_cd IN (${anys_type_cd})
		AND b.cd_grp_id='RISK_STEP_CD'
		AND a.risk_step_cd = b.CD_ID
		AND a.anys_sys_cd= #{anys_sys_cd}
		AND a.factory_hrrc_cd= IFNULL(#{factory_hrrc_cd}, a.factory_hrrc_cd)
		AND a.factory_id=#{factory_id}
		AND a.scen_id = c.scen_id
		GROUP BY a.anys_ymd,
		   a.factory_id,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc,
            a.ANYS_TYPE_CD;
		]]>
	</select>
	
	
		<select id="commLisScnrsHourlyDesc" resultType="hashmap">
	<![CDATA[       
        SELECT
			a.anys_type_cd,
			a.anys_ymdh,
		    a.factory_id ,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc,
			MAX(lpad(a.risk_num,5,'0')) as risk_num,
			MAX((SELECT 
					c.cd_nm 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) as risk_step_nm,
			MAX((SELECT 
					c.CD_ID
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) as risk_step_id,		  	
			MAX(  concat(lpad(a.risk_num,5,'0'),':',(SELECT 
					c.cd_nm 
				  FROM sgscdb.tc_common_code c 
				  WHERE cd_grp_id='RISK_STEP_CD' 
				  AND c.cd_id = a.risk_step_cd)) ) as risk_num_nm
             
			
		FROM sgscdb.th_acdnt_scnrs_anay_load_hourly a, sgscdb.tc_common_code b, sgscdb.tc_acdent_scnrs c
		WHERE a.anys_ymdh = #{anys_ymdh}
        AND a.anys_type_cd IN (${anys_type_cd})
        AND a.anys_sys_cd= #{anys_sys_cd}
		AND b.cd_grp_id='RISK_STEP_CD'
		AND a.risk_step_cd = b.CD_ID	
		AND a.factory_hrrc_cd= IFNULL(#{factory_hrrc_cd}, a.factory_hrrc_cd)
		AND a.factory_id = #{factory_id}
		AND a.scen_id = c.scen_id
		GROUP BY a.anys_ymdh,
		   a.factory_id,
			c.scen_nm,
			c.scen_cause,
			c.scen_result,
			c.etc,
            a.ANYS_TYPE_CD;
		]]>
	</select>
	
	
	<select id="sample" resultType="hashmap">>	
				<![CDATA[
			SELECT 
		 T1.qtime_by_3hour,
		 T1.qtime,
		 T1.risk_type_id,
		 T1.risk_type_nm,
		 T1.anys_ymdh,
		 T1.ymd,
		 T1.risk_rate,
		 T1.risk_num,
		 T1.risk_step_nm
		FROM(      
		        SELECT
					a.risk_type_id,
					b.risk_type_nm,
					a.anys_ymdh,
		            CASE WHEN SUBSTR(a.anys_ymdh,9) = '00' THEN '00'
						 WHEN SUBSTR(a.anys_ymdh,9) = '03' THEN '03'
		                 WHEN SUBSTR(a.anys_ymdh,9) = '06' THEN '06' 
		                 WHEN SUBSTR(a.anys_ymdh,9) = '09' THEN '09' 
		                 WHEN SUBSTR(a.anys_ymdh,9) = '12' THEN '12' 
		                 WHEN SUBSTR(a.anys_ymdh,9) = '15' THEN '15' 
		                 WHEN SUBSTR(a.anys_ymdh,9) = '18' THEN '18' 
		                 WHEN SUBSTR(a.anys_ymdh,9) = '21' THEN '21' 
		            ELSE '0'
		            END qtime_by_3hour,
					SUBSTR(a.anys_ymdh,9) qtime,
					SUBSTR(a.anys_ymdh,1,8) ymd,
		            MAX(lpad(risk_num,5,'0')) risk_num,
		            MAX(
						(SELECT 
								c.cd_nm 
						FROM sgscdb.tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.risk_step_cd))risk_step_nm,
					MAX(concat(lpad(risk_num,5,'0'), ':', 
						(SELECT 
								c.cd_nm 
						FROM sgscdb.tc_common_code c 
						WHERE cd_grp_id='RISK_STEP_CD' 
						AND c.cd_id = a.risk_step_cd))) risk_rate
				FROM sgscdb.th_proces_risk_anay_rtme_load_hourly a , sgscdb.vw_process d, sgscdb.tc_risk_type b
				WHERE SUBSTR(anys_ymdh,1,8) BETWEEN '20210730' and '20210731'
				and a.risk_type_id='KIES102'
				AND a.procs_id = d.procs_id	
				AND a.procs_id = 'P00000'
				AND a.risk_type_id = b.risk_type_id
				GROUP BY risk_type_id, a.anys_ymdh
				order by a.anys_ymdh desc) T1
		        WHERE T1.qtime_by_3hour != '0'
		            ]]>
        </select>	
    
</mapper>